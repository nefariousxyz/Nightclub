<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hypeclub City</title>
    <link rel="stylesheet" href="css/styles.css">
    <link rel="stylesheet" href="css/tutorial.css">

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Phosphor Icons -->
    <script src="https://unpkg.com/@phosphor-icons/web" crossorigin="anonymous"></script>

    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=Orbitron:wght@500;700;900&display=swap"
        rel="stylesheet">

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js" crossorigin="anonymous"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js" crossorigin="anonymous"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"
        crossorigin="anonymous"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"
        crossorigin="anonymous"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-storage-compat.js" crossorigin="anonymous"></script>

    <!-- Global Error Handler for better debugging -->
    <script>
        window.onerror = function (msg, url, line, col, error) {
            if (msg === 'Script error.' && !url) {
                // Ignore generic cross-origin errors
                return true;
            }
            console.error('Error:', msg, 'at', url, 'line', line, col, error);
            return false;
        };
        window.addEventListener('unhandledrejection', function (e) {
            console.error('Unhandled Promise:', e.reason);
        });
    </script>

    <!-- Import map polyfill for Safari -->
    <script async src="https://ga.jspm.io/npm:es-module-shims@1.8.0/dist/es-module-shims.js"></script>

    <script type="importmap">
        {
            "imports": {
                "three": "https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.module.js",
                "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.160.0/examples/jsm/"
            }
        }
    </script>

    <!-- Tailwind Config -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        'display': ['Orbitron', 'sans-serif'],
                        'body': ['Inter', 'sans-serif'],
                    },
                    colors: {
                        'glass': 'rgba(30, 30, 50, 0.7)',
                        'glass-light': 'rgba(50, 50, 80, 0.5)',
                        'neon-pink': '#ff0066',
                        'neon-blue': '#00d4ff',
                        'neon-purple': '#a855f7',
                        'neon-green': '#22c55e',
                    }
                }
            }
        }
    </script>

    <style>
        /* Global Orbitron Font */
        * {
            font-family: 'Orbitron', 'Inter', sans-serif !important;
        }

        body,
        html {
            font-family: 'Orbitron', 'Inter', sans-serif !important;
        }

        .font-display,
        .font-body {
            font-family: 'Orbitron', sans-serif !important;
        }

        /* Glassmorphism base styles */
        .glass-panel {
            background: rgba(20, 20, 35, 0.85);
            -webkit-backdrop-filter: blur(20px);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        /* Hide scrollbar for dock on mobile */
        .scrollbar-hide {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        .scrollbar-hide::-webkit-scrollbar {
            display: none;
        }

        /* Modal responsiveness */
        .modal-overlay {
            z-index: 9000 !important;
        }

        .modal-overlay .glass-panel,
        .modal-overlay .modal-content {
            max-height: 85vh;
            max-height: 85dvh;
            overflow-y: auto;
        }

        @media (max-width: 640px) {
            .modal-overlay {
                padding: 8px !important;
            }

            .modal-overlay .glass-panel,
            .modal-overlay .modal-content {
                max-height: 90vh;
                max-height: 90dvh;
                border-radius: 16px !important;
            }

            .modal-overlay .glass-panel>div:first-child {
                padding: 12px 16px !important;
            }

            /* Smaller notifications on mobile */
            #notification-area>div {
                padding: 8px 12px !important;
                font-size: 11px !important;
                max-width: 280px !important;
            }

            #notification-area>div h4 {
                font-size: 12px !important;
            }

            #notification-area>div p {
                font-size: 10px !important;
            }
        }

        .glass-panel-light {
            background: rgba(40, 40, 70, 0.6);
            -webkit-backdrop-filter: blur(15px);
            backdrop-filter: blur(15px);
            border: 1px solid rgba(255, 255, 255, 0.08);
        }

        .gradient-cash {
            background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%);
        }

        .gradient-gems {
            background: linear-gradient(135deg, #a855f7 0%, #7c3aed 100%);
        }

        .gradient-level {
            background: linear-gradient(135deg, #3b82f6 0%, #6366f1 100%);
        }

        .gradient-party {
            background: linear-gradient(135deg, #f59e0b 0%, #ea580c 100%);
        }

        .text-glow {
            text-shadow: 0 0 10px currentColor, 0 0 20px currentColor;
        }

        .icon-btn {
            transition: all 0.2s ease;
        }

        .icon-btn:hover {
            transform: translateY(-3px);
        }

        .icon-btn:active {
            transform: scale(0.95);
        }

        .floating-text {
            animation: floatUp 1.5s ease-out forwards;
        }

        @keyframes floatUp {
            0% {
                opacity: 1;
                transform: translateY(0);
            }

            100% {
                opacity: 0;
                transform: translateY(-50px);
            }
        }

        .pulse-glow {
            animation: pulseGlow 2s ease-in-out infinite;
        }

        @keyframes pulseGlow {

            0%,
            100% {
                box-shadow: 0 0 5px currentColor;
            }

            50% {
                box-shadow: 0 0 20px currentColor, 0 0 30px currentColor;
            }
        }
    </style>
</head>

<body>
    <!-- Error Log -->
    <div id="error-log"></div>

    <!-- Loading Screen -->
    <div id="loading">
        <div class="loading-logo">
            <img src="assets/logo.png" alt="HYPECLUB CITY"
                style="width: 400px; height: auto; filter: drop-shadow(0 0 20px rgba(255, 215, 0, 0.5));">
        </div>
        <div class="loading-bar">
            <div class="loading-bar-fill" id="loading-progress"></div>
        </div>
        <div class="loading-text" id="loading-text">Powering up the party...</div>
    </div>

    <script>
        // Loading Screen Animation
        document.addEventListener('DOMContentLoaded', () => {
            const progressBar = document.getElementById('loading-progress');
            const loadingText = document.getElementById('loading-text');
            const messages = [
                'Powering up the party...',
                'Mixing the beats...',
                'Stocking the bar...',
                'Inviting VIP guests...',
                'Testing the lights...',
                'Checking sound system...'
            ];

            let progress = 0;
            let messageIndex = 0;

            // Animate progress bar
            const interval = setInterval(() => {
                // Randomize progress increment for "real" feel
                progress += Math.random() * 5;
                if (progress > 100) progress = 100;

                if (progressBar) {
                    progressBar.style.width = `${progress}%`;
                }

                // Change text every ~20%
                if (progress > (messageIndex + 1) * (100 / messages.length) && messageIndex < messages.length - 1) {
                    messageIndex++;
                    if (loadingText) {
                        loadingText.style.opacity = 0;
                        setTimeout(() => {
                            loadingText.textContent = messages[messageIndex];
                            loadingText.style.opacity = 1;
                        }, 200);
                    }
                }

                if (progress >= 100) {
                    clearInterval(interval);
                    if (loadingText) loadingText.textContent = 'Ready to Party!';
                }
            }, 100);
        });
    </script>

    <!-- Session Check Loading Screen -->
    <div id="session-loader" style="
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: linear-gradient(135deg, #0a0a1a 0%, #1a0a2e 50%, #0a1a2e 100%);
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        z-index: 99999;
        transition: opacity 0.5s ease;
    ">
        <img src="assets/logo.png" alt="Hypeclub City"
            style="height: 80px; margin-bottom: 24px; animation: pulse 2s infinite;">
        <div style="
            width: 200px;
            height: 4px;
            background: rgba(255,255,255,0.1);
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 16px;
        ">
            <div id="session-progress" style="
                width: 0%;
                height: 100%;
                background: linear-gradient(90deg, #ff0066, #ff6b9d);
                border-radius: 4px;
                animation: loading 1.5s ease-in-out infinite;
            "></div>
        </div>
        <p style="color: rgba(255,255,255,0.6); font-size: 14px; font-family: 'Inter', sans-serif;">
            Checking session...
        </p>
        <style>
            @keyframes loading {
                0% {
                    width: 0%;
                    margin-left: 0;
                }

                50% {
                    width: 60%;
                    margin-left: 20%;
                }

                100% {
                    width: 0%;
                    margin-left: 100%;
                }
            }

            @keyframes pulse {

                0%,
                100% {
                    opacity: 1;
                    transform: scale(1);
                }

                50% {
                    opacity: 0.8;
                    transform: scale(0.98);
                }
            }
        </style>
    </div>

    <!-- Landing Page -->
    <div id="login-gate" class="landing-page hidden" style="display: none;">
        <!-- Background Orbs -->
        <div class="bg-orbs">
            <div class="orb orb-1"></div>
            <div class="orb orb-2"></div>
            <div class="orb orb-3"></div>
        </div>

        <!-- Fixed Navigation -->
        <nav class="nav-bar">
            <div class="nav-content">
                <div class="nav-logo">
                    <img src="assets/logo.png" alt="Hypeclub City" style="height:40px; width:auto;">
                    <span class="logo-text">HYPECLUB<span class="logo-accent">CITY</span></span>
                </div>
                <div class="nav-links desktop-nav">
                    <a href="#features" onclick="smoothScroll('features')">Features</a>
                    <a href="#leaderboards" onclick="smoothScroll('leaderboards')">Leaderboards</a>
                    <a href="#how-to-play" onclick="smoothScroll('how-to-play')">How to Play</a>
                    <a href="#premium" onclick="smoothScroll('premium')">Premium</a>
                    <button class="nav-btn" onclick="openLoginModal()">Login</button>
                    <button class="nav-btn-primary" onclick="openLoginModal()">‚ñ∂ Play Now</button>
                </div>
                <button class="mobile-menu-btn" onclick="toggleMobileMenu()">‚ò∞</button>
            </div>
            <div class="mobile-nav hidden" id="mobile-nav">
                <a href="#features" onclick="smoothScroll('features');toggleMobileMenu()">Features</a>
                <a href="#leaderboards" onclick="smoothScroll('leaderboards');toggleMobileMenu()">Leaderboards</a>
                <a href="#how-to-play" onclick="smoothScroll('how-to-play');toggleMobileMenu()">How to Play</a>
                <a href="#premium" onclick="smoothScroll('premium');toggleMobileMenu()">Premium</a>
                <button class="nav-btn-primary" onclick="openLoginModal();toggleMobileMenu()">‚ñ∂ Play Now</button>
            </div>
        </nav>

        <!-- Hero Section with 3D DJ Parallax -->
        <section class="hero-section" id="hero">
            <canvas id="hero-3d-canvas"></canvas>
            <div class="hero-content">
                <img src="assets/logo.png" alt="Hypeclub City" class="hero-logo"
                    style="height:180px; width:auto; margin-bottom:32px; filter:drop-shadow(0 0 40px rgba(255,0,102,0.6)); animation: heroBounce 3s ease-in-out infinite;">
                <div class="hero-badge">üéÆ #1 Club Tycoon Game</div>
                <h1 class="hero-title">Build Your Dream<br><span class="text-gradient">Hypeclub Empire</span></h1>
                <p class="hero-subtitle">Create, customize and manage your own nightclub. Hire staff, book celebrity
                    DJs, throw epic parties and become the city's hottest venue!</p>
                <div class="hero-buttons">
                    <button class="btn-primary btn-glow" onclick="openLoginModal()">üöÄ Start Playing Free</button>
                    <button class="btn-secondary" onclick="smoothScroll('features')">Learn More ‚Üì</button>
                </div>
                <div class="hero-stats">
                    <div class="stat"><span class="stat-num">10K+</span><span class="stat-label">Players</span></div>
                    <div class="stat-divider"></div>
                    <div class="stat"><span class="stat-num">5K+</span><span class="stat-label">Clubs</span></div>
                    <div class="stat-divider"></div>
                    <div class="stat"><span class="stat-num">Free</span><span class="stat-label">To Play</span></div>
                </div>
                <div class="scroll-indicator" onclick="smoothScroll('features')">
                    <span>Scroll</span>
                    <div class="scroll-arrow">‚Üì</div>
                </div>
            </div>
        </section>

        <!-- Features Section -->
        <section class="features-section" id="features">
            <div class="section-header">
                <span class="section-badge">‚ú® Features</span>
                <h2 class="section-title">Why Players Love <span class="text-gradient">Hypeclub City</span></h2>
                <p class="section-subtitle">Everything you need to build and manage the ultimate nightclub</p>
            </div>
            <div class="features-grid">
                <div class="feature-card" data-aos>
                    <div class="feature-icon">üèóÔ∏è</div>
                    <h3>Build & Design</h3>
                    <p>Create your perfect club with 100+ furniture items, lighting effects, and decorations</p>
                </div>
                <div class="feature-card" data-aos>
                    <div class="feature-icon">üéß</div>
                    <h3>Book Celebrity DJs</h3>
                    <p>Hire famous DJs with unique skills to boost your club's reputation and earnings</p>
                </div>
                <div class="feature-card" data-aos>
                    <div class="feature-icon">üë•</div>
                    <h3>Hire Staff</h3>
                    <p>Build your dream team with bartenders, bouncers, promoters, and managers</p>
                </div>
                <div class="feature-card" data-aos>
                    <div class="feature-icon">üéâ</div>
                    <h3>Host Events</h3>
                    <p>Throw themed parties, VIP nights, and special events to attract more guests</p>
                </div>
                <div class="feature-card" data-aos>
                    <div class="feature-icon">üí∞</div>
                    <h3>Earn & Expand</h3>
                    <p>Maximize profits, unlock new venues, and build your nightlife empire</p>
                </div>
                <div class="feature-card" data-aos>
                    <div class="feature-icon">üèÜ</div>
                    <h3>Compete & Win</h3>
                    <p>Rise through the leaderboards and become the #1 club owner in the city</p>
                </div>
            </div>
        </section>

        <!-- Leaderboards Section -->
        <section class="leaderboards-section" id="leaderboards">
            <div class="section-header">
                <span class="section-badge">üèÜ Live Rankings</span>
                <h2 class="section-title">Top Players & Clubs</h2>
                <p class="section-subtitle">See who's dominating the nightlife scene</p>
            </div>
            <div class="leaderboards-grid">
                <div class="leaderboard-card">
                    <div class="leaderboard-header"><span>üèÜ</span> Top Players <span class="live-badge">‚óè Live</span>
                    </div>
                    <div class="leaderboard-list" id="landing-top-players">
                        <div class="lb-item skeleton"></div>
                        <div class="lb-item skeleton"></div>
                        <div class="lb-item skeleton"></div>
                    </div>
                </div>
                <div class="leaderboard-card">
                    <div class="leaderboard-header"><span>üè¢</span> Top Clubs</div>
                    <div class="leaderboard-list" id="landing-top-clubs">
                        <div class="lb-item skeleton"></div>
                        <div class="lb-item skeleton"></div>
                        <div class="lb-item skeleton"></div>
                    </div>
                </div>
            </div>
        </section>

        <!-- How to Play Section -->
        <section class="how-section" id="how-to-play">
            <div class="section-header">
                <span class="section-badge">üéÆ Getting Started</span>
                <h2 class="section-title">Start Playing in <span class="text-gradient">4 Easy Steps</span></h2>
            </div>
            <div class="steps-container">
                <div class="step" data-aos>
                    <div class="step-num">1</div>
                    <h3>Create Account</h3>
                    <p>Sign up free with email or Google. Takes 30 seconds!</p>
                </div>
                <div class="step" data-aos>
                    <div class="step-num">2</div>
                    <h3>Name Your Club</h3>
                    <p>Choose a unique name for your nightclub empire</p>
                </div>
                <div class="step" data-aos>
                    <div class="step-num">3</div>
                    <h3>Design & Build</h3>
                    <p>Place furniture, hire staff, and customize your vibe</p>
                </div>
                <div class="step" data-aos>
                    <div class="step-num">4</div>
                    <h3>Open & Profit</h3>
                    <p>Let guests in and watch the money roll in!</p>
                </div>
            </div>
        </section>

        <!-- Premium Section -->
        <section class="premium-section" id="premium">
            <div class="section-header">
                <span class="section-badge">üíé Premium</span>
                <h2 class="section-title">Choose Your Plan</h2>
                <p class="section-subtitle">Play free forever or unlock exclusive benefits</p>
            </div>
            <div class="pricing-grid">
                <div class="pricing-card">
                    <div class="pricing-header">
                        <h3>Free</h3>
                        <div class="price">$0<span>/forever</span></div>
                    </div>
                    <ul class="pricing-features">
                        <li>‚úì Full game access</li>
                        <li>‚úì Basic furniture</li>
                        <li>‚úì Cloud saves</li>
                        <li>‚úì Daily bonuses</li>
                    </ul>
                    <button class="btn-secondary" onclick="openLoginModal()">Play Free</button>
                </div>
                <div class="pricing-card featured">
                    <div class="popular-tag">Most Popular</div>
                    <div class="pricing-header">
                        <h3>üëë VIP</h3>
                        <div class="price">$4.99<span>/month</span></div>
                    </div>
                    <ul class="pricing-features">
                        <li>‚úì Everything in Free</li>
                        <li>‚úì 2x XP earnings</li>
                        <li>‚úì Exclusive furniture</li>
                        <li>‚úì VIP badge</li>
                        <li>‚úì 500 bonus diamonds</li>
                    </ul>
                    <button class="btn-primary" onclick="openLoginModal()">Get VIP</button>
                </div>
                <div class="pricing-card">
                    <div class="pricing-header">
                        <h3>üíé Diamonds</h3>
                        <div class="price">From $0.99</div>
                    </div>
                    <ul class="pricing-features">
                        <li>‚úì 100 diamonds - $0.99</li>
                        <li>‚úì 550 diamonds - $4.99</li>
                        <li>‚úì 1,300 diamonds - $9.99</li>
                        <li>‚úì Premium items</li>
                    </ul>
                    <button class="btn-secondary" onclick="openLoginModal()">Buy Diamonds</button>
                </div>
            </div>
        </section>

        <!-- Final CTA Section -->
        <section class="cta-section">
            <div class="cta-content">
                <h2>Ready to Build Your <span class="text-gradient">Empire</span>?</h2>
                <p>Join thousands of players creating their dream clubs. Start free today!</p>
                <button class="btn-primary btn-large btn-glow" onclick="openLoginModal()">üéÆ Start Playing Now - It's
                    Free!</button>
                <div class="cta-features">
                    <span>‚úì No credit card required</span>
                    <span>‚úì Play instantly in browser</span>
                    <span>‚úì Cloud saves included</span>
                </div>
            </div>
        </section>

        <!-- Footer -->
        <footer class="landing-footer">
            <div class="footer-grid">
                <div class="footer-brand">
                    <div class="footer-logo">üåÉ HYPECLUB<span>CITY</span></div>
                    <p>The ultimate nightclub tycoon game. Build, manage, and dominate the nightlife scene.</p>
                </div>
                <div class="footer-col">
                    <h4>Game</h4>
                    <a href="#features">Features</a>
                    <a href="#how-to-play">How to Play</a>
                    <a href="#premium">Premium</a>
                </div>
                <div class="footer-col">
                    <h4>Community</h4>
                    <a href="#leaderboards">Leaderboards</a>
                    <a href="#">Discord</a>
                    <a href="#">Twitter</a>
                </div>
                <div class="footer-col">
                    <h4>Legal</h4>
                    <a href="#">Privacy Policy</a>
                    <a href="#">Terms of Service</a>
                    <a href="#">Contact</a>
                </div>
            </div>
            <div class="footer-bottom">
                <span>¬© 2025 Hypeclub City. All rights reserved.</span>
                <span class="version">v2.0</span>
            </div>
        </footer>
    </div>

    <!-- Login Modal -->
    <div id="login-modal" class="login-modal hidden">
        <div class="login-backdrop" onclick="closeLoginModal()"></div>
        <div class="modal-content">
            <button class="modal-close" onclick="closeLoginModal()">‚úï</button>
            <div class="modal-header">
                <div class="modal-logo"><img src="assets/logo.png" alt="Hypeclub City" style="height:80px; width:auto;">
                </div>
                <h2>Welcome to <span class="text-gradient">Hypeclub City</span></h2>
            </div>
            <div class="modal-tabs">
                <button class="modal-tab active" onclick="switchGateTab('login')">Login</button>
                <button class="modal-tab" onclick="switchGateTab('register')">Register</button>
            </div>
            <div id="gate-login-form" class="modal-form">
                <div class="form-group"><span class="form-icon">üìß</span><input type="email" id="gate-login-email"
                        placeholder="Email address"></div>
                <div class="form-group"><span class="form-icon">üîí</span><input type="password" id="gate-login-password"
                        placeholder="Password"></div>
                <button onclick="gateLogin()" class="form-submit">‚ñ∂ Login & Play</button>
                <button onclick="gateForgotPassword()" class="form-link">Forgot password?</button>
            </div>
            <div id="gate-register-form" class="modal-form hidden">
                <div class="form-group"><span class="form-icon">üë§</span><input type="text" id="gate-register-name"
                        placeholder="Your name"></div>
                <div class="form-group"><span class="form-icon">üè¢</span><input type="text" id="gate-register-club"
                        placeholder="Club name"></div>
                <div class="form-group"><span class="form-icon">üìß</span><input type="email" id="gate-register-email"
                        placeholder="Email address"></div>
                <div class="form-group"><span class="form-icon">üîí</span><input type="password"
                        id="gate-register-password" placeholder="Password (min 6 chars)"></div>
                <button onclick="gateRegister()" class="form-submit">üöÄ Create & Play</button>
            </div>
            <div class="form-divider"><span>or</span></div>
            <button onclick="gateGoogleLogin()" class="google-btn"><img src="https://www.google.com/favicon.ico"
                    alt="Google"> Sign in with Google</button>
        </div>
    </div>

    <style>
        /* Landing Page - Scrollable */
        .landing-page {
            position: fixed;
            inset: 0;
            overflow-y: scroll !important;
            overflow-x: hidden;
            background: linear-gradient(180deg, #0a0a1a 0%, #0d0d25 30%, #0a0a1a 100%);
            z-index: 100000;
            font-family: 'Orbitron', sans-serif;
            scroll-behavior: smooth;
        }

        .landing-page.hidden {
            display: none !important;
        }

        .text-gradient {
            background: linear-gradient(135deg, #ff0066, #a855f7);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        /* Animated Background Orbs */
        .bg-orbs {
            position: fixed;
            inset: 0;
            pointer-events: none;
            overflow: hidden;
            z-index: 0;
        }

        .orb {
            position: absolute;
            border-radius: 50%;
            filter: blur(80px);
            animation: orbFloat 20s ease-in-out infinite;
        }

        .orb-1 {
            width: 600px;
            height: 600px;
            background: radial-gradient(circle, rgba(255, 0, 102, 0.15), transparent 70%);
            top: -200px;
            left: -200px;
        }

        .orb-2 {
            width: 500px;
            height: 500px;
            background: radial-gradient(circle, rgba(168, 85, 247, 0.15), transparent 70%);
            bottom: -150px;
            right: -150px;
            animation-delay: -7s;
        }

        .orb-3 {
            width: 400px;
            height: 400px;
            background: radial-gradient(circle, rgba(0, 212, 255, 0.1), transparent 70%);
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            animation-delay: -14s;
        }

        @keyframes orbFloat {

            0%,
            100% {
                transform: translate(0, 0) scale(1);
            }

            50% {
                transform: translate(30px, -30px) scale(1.1);
            }
        }

        /* Navigation */
        .nav-bar {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 10000;
            padding: 12px 24px;
            background: rgba(10, 10, 26, 0.9);
            -webkit-backdrop-filter: blur(20px);
            backdrop-filter: blur(20px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            transition: all 0.3s;
        }

        .nav-content {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .nav-logo {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .logo-icon {
            font-size: 28px;
        }

        .logo-text {
            font-size: 18px;
            font-weight: 900;
            color: white;
        }

        .logo-accent {
            color: #ff0066;
        }

        .desktop-nav {
            display: flex;
            align-items: center;
            gap: 24px;
        }

        .nav-links a {
            color: rgba(255, 255, 255, 0.7);
            text-decoration: none;
            font-size: 12px;
            font-weight: 600;
            transition: color 0.2s;
        }

        .nav-links a:hover {
            color: white;
        }

        .nav-btn {
            padding: 8px 16px;
            background: transparent;
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: white;
            border-radius: 8px;
            font-size: 11px;
            font-weight: 700;
            cursor: pointer;
            font-family: inherit;
            transition: all 0.2s;
        }

        .nav-btn:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .nav-btn-primary {
            padding: 8px 20px;
            background: linear-gradient(135deg, #ff0066, #ff3388);
            border: none;
            color: white;
            border-radius: 8px;
            font-size: 11px;
            font-weight: 700;
            cursor: pointer;
            font-family: inherit;
            transition: all 0.2s;
        }

        .nav-btn-primary:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 15px rgba(255, 0, 102, 0.4);
        }

        .mobile-menu-btn {
            display: none;
            background: none;
            border: none;
            color: white;
            font-size: 24px;
            cursor: pointer;
        }

        .mobile-nav {
            display: none;
            flex-direction: column;
            gap: 12px;
            padding: 16px;
            background: rgba(10, 10, 26, 0.95);
            border-top: 1px solid rgba(255, 255, 255, 0.05);
        }

        .mobile-nav a {
            color: rgba(255, 255, 255, 0.7);
            text-decoration: none;
            font-size: 14px;
            padding: 8px 0;
        }

        .mobile-nav.hidden {
            display: none;
        }

        @media(max-width:768px) {
            .desktop-nav {
                display: none;
            }

            .mobile-menu-btn {
                display: block;
            }

            .mobile-nav:not(.hidden) {
                display: flex;
            }
        }

        /* Hero Section */
        .hero-section {
            display: block;
            position: relative;
            padding: 140px 24px 80px;
            text-align: center;
        }

        #hero-3d-canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 0;
            pointer-events: none;
            opacity: 0.7;
        }

        .hero-content {
            position: relative;
            z-index: 2;
            max-width: 700px;
            margin: 0 auto;
        }

        .scroll-indicator {
            margin-top: 40px;
            text-align: center;
            cursor: pointer;
        }

        .hero-badge {
            display: inline-block;
            padding: 8px 16px;
            background: rgba(255, 0, 102, 0.15);
            border: 1px solid rgba(255, 0, 102, 0.3);
            border-radius: 50px;
            font-size: 11px;
            font-weight: 700;
            color: #ff6699;
            margin-bottom: 20px;
        }

        .hero-title {
            font-size: clamp(36px, 7vw, 64px);
            font-weight: 900;
            color: white;
            line-height: 1.1;
            margin-bottom: 20px;
        }

        .hero-subtitle {
            font-size: 16px;
            color: rgba(255, 255, 255, 0.6);
            line-height: 1.7;
            margin-bottom: 32px;
            font-family: 'Inter', sans-serif;
            max-width: 550px;
            margin-left: auto;
            margin-right: auto;
        }

        .hero-buttons {
            display: flex;
            gap: 16px;
            justify-content: center;
            flex-wrap: wrap;
            margin-bottom: 48px;
        }

        .btn-primary {
            padding: 16px 32px;
            background: linear-gradient(135deg, #ff0066, #ff3388);
            border: none;
            color: white;
            border-radius: 12px;
            font-size: 15px;
            font-weight: 700;
            cursor: pointer;
            font-family: inherit;
            transition: all 0.3s;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(255, 0, 102, 0.4);
        }

        .btn-glow {
            box-shadow: 0 4px 20px rgba(255, 0, 102, 0.4);
        }

        .btn-secondary {
            padding: 16px 32px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.15);
            color: white;
            border-radius: 12px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            font-family: inherit;
            transition: all 0.2s;
        }

        .btn-secondary:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .btn-large {
            padding: 18px 40px;
            font-size: 16px;
        }

        .hero-stats {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 24px;
            margin-bottom: 50px;
        }

        .stat {
            text-align: center;
        }

        .stat-num {
            display: block;
            font-size: 28px;
            font-weight: 900;
            color: white;
        }

        .stat-label {
            font-size: 11px;
            color: rgba(255, 255, 255, 0.5);
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .stat-divider {
            width: 1px;
            height: 40px;
            background: rgba(255, 255, 255, 0.1);
        }

        .scroll-indicator span {
            font-size: 10px;
            color: rgba(255, 255, 255, 0.4);
            text-transform: uppercase;
            letter-spacing: 2px;
            display: block;
            margin-bottom: 8px;
        }

        .scroll-arrow {
            font-size: 20px;
            color: rgba(255, 255, 255, 0.4);
        }

        @keyframes bounce {

            0%,
            100% {
                transform: translateX(-50%) translateY(0);
            }

            50% {
                transform: translateX(-50%) translateY(8px);
            }
        }

        @keyframes heroBounce {

            0%,
            100% {
                transform: translateY(0) scale(1);
                filter: drop-shadow(0 0 40px rgba(255, 0, 102, 0.6));
            }

            50% {
                transform: translateY(-15px) scale(1.02);
                filter: drop-shadow(0 0 60px rgba(255, 0, 102, 0.8));
            }
        }

        /* Section Styles */
        section {
            position: relative;
            z-index: 1;
        }

        .section-header {
            text-align: center;
            max-width: 600px;
            margin: 0 auto 48px;
        }

        .section-badge {
            display: inline-block;
            padding: 6px 14px;
            background: rgba(168, 85, 247, 0.15);
            border: 1px solid rgba(168, 85, 247, 0.3);
            border-radius: 50px;
            font-size: 11px;
            font-weight: 700;
            color: #c084fc;
            margin-bottom: 16px;
        }

        .section-title {
            font-size: clamp(28px, 5vw, 40px);
            font-weight: 900;
            color: white;
            margin-bottom: 12px;
        }

        .section-subtitle {
            font-size: 14px;
            color: rgba(255, 255, 255, 0.5);
            font-family: 'Inter', sans-serif;
        }

        /* Features Section */
        .features-section {
            padding: 100px 24px;
            background: rgba(0, 0, 0, 0.2);
        }

        .features-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 24px;
            max-width: 1100px;
            margin: 0 auto;
        }

        .feature-card {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.06);
            border-radius: 20px;
            padding: 32px;
            text-align: center;
            transition: all 0.3s;
        }

        .feature-card:hover {
            transform: translateY(-8px);
            border-color: rgba(255, 0, 102, 0.3);
            background: rgba(255, 255, 255, 0.05);
        }

        .feature-icon {
            font-size: 48px;
            margin-bottom: 20px;
        }

        .feature-card h3 {
            font-size: 18px;
            font-weight: 700;
            color: white;
            margin-bottom: 10px;
        }

        .feature-card p {
            font-size: 13px;
            color: rgba(255, 255, 255, 0.5);
            line-height: 1.6;
            font-family: 'Inter', sans-serif;
        }

        /* Leaderboards Section */
        .leaderboards-section {
            padding: 100px 24px;
        }

        .leaderboards-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 24px;
            max-width: 900px;
            margin: 0 auto;
        }

        .leaderboard-card {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.06);
            border-radius: 20px;
            overflow: hidden;
        }

        .leaderboard-header {
            padding: 20px 24px;
            background: rgba(255, 255, 255, 0.02);
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            font-size: 16px;
            font-weight: 700;
            color: white;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .live-badge {
            margin-left: auto;
            font-size: 10px;
            color: #22c55e;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0.5;
            }
        }

        .leaderboard-list {
            padding: 16px;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .lb-item {
            padding: 12px 16px;
            background: rgba(255, 255, 255, 0.02);
            border-radius: 10px;
            height: 50px;
        }

        .lb-item.skeleton {
            background: linear-gradient(90deg, rgba(255, 255, 255, 0.02) 0%, rgba(255, 255, 255, 0.05) 50%, rgba(255, 255, 255, 0.02) 100%);
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite;
        }

        @keyframes shimmer {
            0% {
                background-position: 200% 0;
            }

            100% {
                background-position: -200% 0;
            }
        }

        /* How Section */
        .how-section {
            padding: 100px 24px;
            background: rgba(0, 0, 0, 0.2);
        }

        .steps-container {
            display: flex;
            justify-content: center;
            gap: 24px;
            flex-wrap: wrap;
            max-width: 1100px;
            margin: 0 auto;
        }

        .step {
            text-align: center;
            flex: 1;
            min-width: 220px;
            max-width: 260px;
            padding: 32px 24px;
            background: rgba(255, 255, 255, 0.02);
            border: 1px solid rgba(255, 255, 255, 0.05);
            border-radius: 20px;
            transition: all 0.3s;
        }

        .step:hover {
            transform: translateY(-4px);
            border-color: rgba(255, 0, 102, 0.2);
        }

        .step-num {
            width: 56px;
            height: 56px;
            background: linear-gradient(135deg, #ff0066, #a855f7);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 22px;
            font-weight: 900;
            color: white;
            margin: 0 auto 20px;
        }

        .step h3 {
            font-size: 16px;
            font-weight: 700;
            color: white;
            margin-bottom: 10px;
        }

        .step p {
            font-size: 13px;
            color: rgba(255, 255, 255, 0.5);
            font-family: 'Inter', sans-serif;
            line-height: 1.5;
        }

        /* Premium Section */
        .premium-section {
            padding: 100px 24px;
        }

        .pricing-grid {
            display: flex;
            justify-content: center;
            gap: 24px;
            flex-wrap: wrap;
            max-width: 1000px;
            margin: 0 auto;
        }

        .pricing-card {
            flex: 1;
            min-width: 280px;
            max-width: 320px;
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.06);
            border-radius: 24px;
            padding: 32px;
            text-align: center;
            transition: all 0.3s;
            position: relative;
        }

        .pricing-card:hover {
            transform: translateY(-4px);
        }

        .pricing-card.featured {
            border-color: rgba(255, 0, 102, 0.4);
            background: rgba(255, 0, 102, 0.05);
        }

        .popular-tag {
            position: absolute;
            top: -12px;
            left: 50%;
            transform: translateX(-50%);
            padding: 6px 16px;
            background: linear-gradient(135deg, #ff0066, #ff3388);
            border-radius: 50px;
            font-size: 10px;
            font-weight: 700;
            color: white;
        }

        .pricing-header h3 {
            font-size: 20px;
            font-weight: 700;
            color: white;
            margin-bottom: 8px;
        }

        .price {
            font-size: 36px;
            font-weight: 900;
            color: white;
        }

        .price span {
            font-size: 14px;
            color: rgba(255, 255, 255, 0.5);
            font-weight: 400;
        }

        .pricing-features {
            list-style: none;
            padding: 24px 0;
            margin: 0;
            text-align: left;
        }

        .pricing-features li {
            padding: 8px 0;
            font-size: 13px;
            color: rgba(255, 255, 255, 0.6);
            font-family: 'Inter', sans-serif;
        }

        .pricing-card button {
            width: 100%;
        }

        /* CTA Section */
        .cta-section {
            padding: 100px 24px;
            background: linear-gradient(135deg, rgba(255, 0, 102, 0.08), rgba(168, 85, 247, 0.08));
        }

        .cta-content {
            text-align: center;
            max-width: 600px;
            margin: 0 auto;
        }

        .cta-content h2 {
            font-size: clamp(28px, 5vw, 40px);
            font-weight: 900;
            color: white;
            margin-bottom: 16px;
        }

        .cta-content p {
            font-size: 16px;
            color: rgba(255, 255, 255, 0.6);
            margin-bottom: 32px;
            font-family: 'Inter', sans-serif;
        }

        .cta-features {
            display: flex;
            justify-content: center;
            gap: 24px;
            flex-wrap: wrap;
            margin-top: 24px;
        }

        .cta-features span {
            font-size: 12px;
            color: rgba(255, 255, 255, 0.5);
        }

        /* Footer */
        .landing-footer {
            padding: 60px 24px 30px;
            background: rgba(0, 0, 0, 0.4);
            border-top: 1px solid rgba(255, 255, 255, 0.05);
        }

        .footer-grid {
            display: grid;
            grid-template-columns: 2fr 1fr 1fr 1fr;
            gap: 40px;
            max-width: 1100px;
            margin: 0 auto 40px;
        }

        @media(max-width:768px) {
            .footer-grid {
                grid-template-columns: 1fr 1fr;
            }
        }

        @media(max-width:480px) {
            .footer-grid {
                grid-template-columns: 1fr;
            }
        }

        .footer-brand p {
            font-size: 13px;
            color: rgba(255, 255, 255, 0.4);
            margin-top: 12px;
            font-family: 'Inter', sans-serif;
            line-height: 1.6;
        }

        .footer-logo {
            font-size: 20px;
            font-weight: 900;
            color: white;
        }

        .footer-logo span {
            color: #ff0066;
        }

        .footer-col h4 {
            font-size: 13px;
            font-weight: 700;
            color: white;
            margin-bottom: 16px;
        }

        .footer-col a {
            display: block;
            font-size: 13px;
            color: rgba(255, 255, 255, 0.4);
            text-decoration: none;
            padding: 6px 0;
            transition: color 0.2s;
        }

        .footer-col a:hover {
            color: white;
        }

        .footer-bottom {
            display: flex;
            justify-content: space-between;
            align-items: center;
            max-width: 1100px;
            margin: 0 auto;
            padding-top: 20px;
            border-top: 1px solid rgba(255, 255, 255, 0.05);
            font-size: 12px;
            color: rgba(255, 255, 255, 0.3);
        }

        .version {
            background: rgba(255, 255, 255, 0.05);
            padding: 4px 10px;
            border-radius: 20px;
        }

        /* Login Modal */
        .login-modal {
            position: fixed;
            inset: 0;
            z-index: 200000;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .login-modal.hidden {
            display: none;
        }

        .login-backdrop {
            position: absolute;
            inset: 0;
            background: rgba(0, 0, 0, 0.9);
        }

        .login-modal .modal-content {
            position: relative;
            width: 100%;
            max-width: 400px;
            background: rgba(20, 20, 40, 0.98);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 24px;
            padding: 36px;
        }

        .login-modal .modal-close {
            position: absolute;
            top: 16px;
            right: 16px;
            background: none;
            border: none;
            color: rgba(255, 255, 255, 0.5);
            font-size: 24px;
            cursor: pointer;
            transition: color 0.2s;
        }

        .login-modal .modal-close:hover {
            color: white;
        }

        .login-modal .modal-header {
            text-align: center;
            margin-bottom: 28px;
        }

        .login-modal .modal-logo {
            font-size: 56px;
            margin-bottom: 12px;
        }

        .login-modal .modal-header h2 {
            font-size: 22px;
            font-weight: 700;
            color: white;
        }

        .modal-tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 24px;
        }

        .modal-tab {
            flex: 1;
            padding: 14px;
            background: rgba(255, 255, 255, 0.05);
            border: none;
            color: rgba(255, 255, 255, 0.6);
            border-radius: 12px;
            font-size: 14px;
            font-weight: 700;
            cursor: pointer;
            font-family: inherit;
            transition: all 0.2s;
        }

        .modal-tab:hover {
            background: rgba(255, 255, 255, 0.08);
        }

        .modal-tab.active {
            background: linear-gradient(135deg, #ff0066, #ff3388);
            color: white;
        }

        .modal-form {
            display: flex;
            flex-direction: column;
            gap: 14px;
        }

        .modal-form.hidden {
            display: none;
        }

        .form-group {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 16px;
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 14px;
            transition: border-color 0.2s;
        }

        .form-group:focus-within {
            border-color: rgba(255, 0, 102, 0.4);
        }

        .form-icon {
            color: rgba(255, 255, 255, 0.4);
            font-size: 16px;
        }

        .form-group input {
            flex: 1;
            background: none;
            border: none;
            outline: none;
            color: white;
            font-size: 14px;
            font-family: inherit;
        }

        .form-group input::placeholder {
            color: rgba(255, 255, 255, 0.3);
        }

        .form-submit {
            padding: 16px;
            background: linear-gradient(135deg, #ff0066, #ff3388);
            border: none;
            border-radius: 14px;
            color: white;
            font-size: 16px;
            font-weight: 700;
            cursor: pointer;
            font-family: inherit;
            margin-top: 8px;
            transition: all 0.2s;
        }

        .form-submit:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 15px rgba(255, 0, 102, 0.4);
        }

        .form-link {
            background: none;
            border: none;
            color: rgba(255, 255, 255, 0.4);
            font-size: 12px;
            cursor: pointer;
            padding: 8px;
            font-family: inherit;
        }

        .form-divider {
            display: flex;
            align-items: center;
            gap: 16px;
            margin: 20px 0;
            color: rgba(255, 255, 255, 0.3);
            font-size: 12px;
        }

        .form-divider::before,
        .form-divider::after {
            content: '';
            flex: 1;
            height: 1px;
            background: rgba(255, 255, 255, 0.1);
        }

        .google-btn {
            width: 100%;
            padding: 14px;
            background: white;
            border: none;
            border-radius: 14px;
            color: #333;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            font-family: inherit;
            transition: all 0.2s;
        }

        .google-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 15px rgba(255, 255, 255, 0.2);
        }

        .google-btn img {
            width: 18px;
            height: 18px;
        }

        @keyframes gatePulse {

            0%,
            100% {
                transform: scale(1);
            }

            50% {
                transform: scale(1.05);
            }
        }

        @keyframes slideInDown {
            from {
                transform: translateY(-100%);
                opacity: 0;
            }

            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        @keyframes fadeOut {
            from {
                opacity: 1;
            }

            to {
                opacity: 0;
                transform: translateY(-20px);
            }
        }

        .animate-slide-in-down {
            animation: slideInDown 0.3s ease-out forwards;
        }

        .animate-fade-out {
            animation: fadeOut 0.3s ease-out forwards;
        }

        .line-clamp-2 {
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
    </style>

    <!-- Visit Mode Banner - Shows when visiting a friend's club -->
    <div id="visit-banner" class="hidden"
        style="position:fixed; top:0; left:0; right:0; z-index:10000; pointer-events:auto;">
        <div
            style="background:linear-gradient(135deg, rgba(139,92,246,0.95), rgba(168,85,247,0.95)); padding:12px 24px; display:flex; align-items:center; justify-content:space-between; -webkit-backdrop-filter:blur(20px); backdrop-filter:blur(20px); border-bottom:2px solid rgba(255,255,255,0.2); box-shadow:0 4px 30px rgba(139,92,246,0.4);">
            <div style="display:flex; align-items:center; gap:16px;">
                <span style="font-size:24px;">üè¢</span>
                <div>
                    <div
                        style="font-size:10px; color:rgba(255,255,255,0.7); text-transform:uppercase; letter-spacing:1px;">
                        Visiting</div>
                    <div style="font-size:18px; font-weight:800; color:white;" id="visit-club-name">Friend's Club</div>
                </div>
            </div>
            <div style="display:flex; align-items:center; gap:12px;">
                <div id="visit-rewards"
                    style="display:flex; gap:12px; background:rgba(0,0,0,0.2); padding:8px 16px; border-radius:12px;">
                    <span style="color:#4ade80; font-weight:700; font-size:14px;" id="visit-cash-reward">+$60</span>
                    <span style="color:#60a5fa; font-weight:700; font-size:14px;" id="visit-xp-reward">+15 XP</span>
                    <span style="color:#f97316; font-weight:700; font-size:14px;" id="visit-hype-reward">+1üî•</span>
                </div>
                <button onclick="returnToMyClub()"
                    style="background:linear-gradient(135deg, #fff, #f0f0f0); color:#1a1a2e; padding:10px 24px; border-radius:12px; border:none; font-weight:800; font-size:14px; cursor:pointer; display:flex; align-items:center; gap:8px; transition:all 0.2s; box-shadow:0 4px 15px rgba(0,0,0,0.2);">
                    <span>‚Üê</span> Back to My Club
                </button>
            </div>
        </div>
    </div>

    <!-- 3D Canvas -->
    <div id="canvas-container"></div>

    <!-- Furniture Edit Bar - Fixed at bottom, responsive -->
    <div id="furniture-edit-bar"
        class="hidden fixed bottom-16 sm:bottom-20 left-1/2 -translate-x-1/2 z-[99999] pointer-events-auto">
        <div
            class="bg-black/95 rounded-xl sm:rounded-2xl px-2 py-2 sm:px-5 sm:py-3 border-2 border-white/20 shadow-2xl flex items-center gap-1 sm:gap-3 flex-wrap justify-center max-w-[95vw]">
            <span id="selection-count"
                class="text-yellow-400 font-bold text-[10px] sm:text-sm min-w-[50px] sm:min-w-[80px] text-center">1
                selected</span>
            <div class="hidden sm:block w-px h-6 bg-white/20"></div>
            <button id="btn-furniture-move" onclick="window.furnitureMove()"
                class="px-2 py-1.5 sm:px-4 sm:py-2 rounded-lg bg-gradient-to-br from-amber-500 to-amber-600 text-white font-bold text-[10px] sm:text-sm">
                ‚úã <span class="hidden sm:inline">Move</span>
            </button>
            <button id="btn-furniture-rotate" onclick="window.furnitureRotate()"
                class="px-2 py-1.5 sm:px-4 sm:py-2 rounded-lg bg-gradient-to-br from-blue-500 to-indigo-600 text-white font-bold text-[10px] sm:text-sm">
                üîÑ <span class="hidden sm:inline">Rotate</span>
            </button>
            <!-- Up/Down for light height adjustment -->
            <button id="btn-furniture-up" onclick="window.furnitureMoveUp && window.furnitureMoveUp()"
                class="px-2 py-1.5 sm:px-3 sm:py-2 rounded-lg bg-gradient-to-br from-green-500 to-emerald-600 text-white font-bold text-[10px] sm:text-sm"
                title="Move Up">
                ‚¨ÜÔ∏è
            </button>
            <button id="btn-furniture-down" onclick="window.furnitureMoveDown && window.furnitureMoveDown()"
                class="px-2 py-1.5 sm:px-3 sm:py-2 rounded-lg bg-gradient-to-br from-green-500 to-emerald-600 text-white font-bold text-[10px] sm:text-sm"
                title="Move Down">
                ‚¨áÔ∏è
            </button>
            <button id="btn-furniture-delete" onclick="window.furnitureDelete()"
                class="px-2 py-1.5 sm:px-4 sm:py-2 rounded-lg bg-gradient-to-br from-red-500 to-red-600 text-white font-bold text-[10px] sm:text-sm">
                üóëÔ∏è <span class="hidden sm:inline">Delete</span>
            </button>
            <button id="btn-furniture-cancel" onclick="window.furnitureCancel()"
                class="px-2 py-1.5 sm:px-3 sm:py-2 rounded-lg bg-white/10 text-white text-[10px] sm:text-sm">
                ‚úï
            </button>
        </div>
        <div class="hidden sm:block text-center mt-2 text-white/50 text-[11px]">
            Shift+Click to select multiple ‚Ä¢ Press Del to delete ‚Ä¢ R to rotate ‚Ä¢ ‚Üë‚Üì to adjust height
        </div>
    </div>

    <!-- UI Layer - Modern Glassmorphism Design -->
    <div id="ui-layer" class="absolute top-0 left-0 w-full h-full flex flex-col justify-between p-2 sm:p-4"
        style="pointer-events: none; z-index: 500;">

        <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê TOP HUD ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
        <div class="flex justify-between items-start w-full pointer-events-auto">

            <!-- Left: Stats -->
            <div class="flex flex-col gap-1 sm:gap-2">
                <!-- Level -->
                <div class="flex items-center gap-1 sm:gap-2">
                    <div
                        class="w-8 h-8 sm:w-10 sm:h-10 rounded-lg sm:rounded-xl bg-gradient-to-br from-violet-600 to-indigo-700 flex items-center justify-center shadow-lg border border-white/20">
                        <div class="text-center leading-none font-display">
                            <span class="block font-bold text-sm sm:text-lg" id="level-display">1</span>
                        </div>
                    </div>
                    <!-- XP Bar (hidden on mobile) -->
                    <div class="hidden sm:flex flex-col justify-center">
                        <div class="text-[10px] font-semibold opacity-80" id="xp-text">0 / 100 XP</div>
                        <div class="w-24 h-2 bg-black/50 rounded-full overflow-hidden border border-white/10">
                            <div id="xp-bar"
                                class="h-full rounded-full bg-gradient-to-r from-violet-500 via-fuchsia-500 to-pink-500 w-0 transition-all duration-300">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Currency -->
                <div class="flex gap-1 sm:gap-2">
                    <div class="glass-panel px-2 sm:px-3 py-1 sm:py-1.5 rounded-full flex items-center gap-1 sm:gap-2">
                        <i class="ph-fill ph-coins text-green-400 text-xs sm:text-sm"></i>
                        <span class="font-bold text-green-400 text-[11px] sm:text-sm" id="cash-display">$0</span>
                    </div>
                    <button
                        class="glass-panel px-2 sm:px-3 py-1 sm:py-1.5 rounded-full flex items-center gap-1 sm:gap-2 hover:bg-white/10 transition-colors"
                        onclick="game.openModal('premium-shop')">
                        <i class="ph-fill ph-diamond text-purple-400 text-xs sm:text-sm"></i>
                        <span class="font-bold text-purple-400 text-[11px] sm:text-sm" id="coins-display">0</span>
                    </button>
                </div>
            </div>

            <!-- Center: Club Info -->
            <div class="hidden md:flex flex-col items-center font-display pointer-events-auto"
                style="position:absolute;left:50%;transform:translateX(-50%);top:16px;">
                <div id="club-badge" class="club-badge badge-default"
                    onclick="console.log('Badge clicked');if(typeof game!=='undefined')game.openModal('badge-shop');else document.getElementById('badge-shop-modal').classList.remove('hidden');"
                    style="cursor:pointer;pointer-events:auto;position:relative;z-index:9999;padding:8px 20px;border-radius:16px;text-align:center;transition:all 0.2s;"
                    onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">
                    <div class="badge-label"
                        style="font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:1px;color:inherit;">
                        Hypeclub City</div>
                    <div class="badge-name" id="club-name-display"
                        style="font-size:20px;font-weight:900;color:inherit;">My Club</div>
                    <div class="badge-glow"></div>
                </div>
                <div class="mt-1 text-xs text-white/70 bg-black/40 px-3 py-1 rounded-full">
                    <span id="game-time">9:00 PM</span> ‚Ä¢ Day <span id="day-count">1</span>
                </div>
                <span id="club-tier-display" class="hidden">Tiny Bar</span>
            </div>

            <!-- Right: Notifications + Profile + VIP + Party + Now Playing -->
            <div class="flex flex-col items-end gap-1 sm:gap-2">
                <div class="flex items-center gap-1 sm:gap-2">
                    <!-- Notification Bell -->
                    <div class="relative">
                        <button id="notification-bell"
                            class="glass-panel p-1.5 sm:p-2.5 rounded-lg sm:rounded-xl hover:bg-white/20 transition-all relative"
                            onclick="toggleNotificationPanel()">
                            <i class="ph-fill ph-bell text-white text-base sm:text-xl"></i>
                            <span id="notification-badge"
                                class="hidden absolute -top-1 -right-1 bg-red-500 text-white text-[8px] sm:text-[10px] font-bold rounded-full w-4 h-4 sm:w-5 sm:h-5 flex items-center justify-center animate-pulse">0</span>
                        </button>

                        <!-- Notification Dropdown -->
                        <div id="notification-panel"
                            class="hidden absolute right-0 top-full mt-2 w-72 sm:w-80 max-h-80 sm:max-h-96 overflow-y-auto bg-black/95 backdrop-blur-xl rounded-2xl border border-white/20 shadow-2xl z-[9999]">
                            <div class="p-3 sm:p-4 border-b border-white/10 flex justify-between items-center">
                                <h3 class="text-white font-bold text-sm">üîî Notifications</h3>
                                <button onclick="clearAllNotifications()"
                                    class="text-xs text-gray-400 hover:text-white transition-colors">Clear All</button>
                            </div>
                            <div id="notification-list" class="p-2">
                                <div class="text-center text-gray-500 text-sm py-8">No notifications yet</div>
                            </div>
                        </div>
                    </div>

                    <button id="profile-btn"
                        class="glass-panel px-2 sm:px-3 py-1.5 sm:py-2 rounded-lg sm:rounded-xl flex items-center gap-1 sm:gap-2 hover:bg-white/20 transition-all"
                        onclick="game.openModal('profile')">
                        <div
                            class="w-6 h-6 sm:w-7 sm:h-7 rounded-full bg-gradient-to-br from-cyan-500 to-blue-600 flex items-center justify-center">
                            <i class="ph-fill ph-user text-white text-xs sm:text-sm"></i>
                        </div>
                        <span class="hidden sm:inline text-xs font-bold text-white"
                            id="owner-name-display">Profile</span>
                    </button>

                    <div id="vip-badge"
                        class="hidden bg-yellow-500/20 rounded-lg px-1.5 sm:px-2 py-0.5 sm:py-1 border border-yellow-500/30">
                        <span class="text-yellow-400 text-[8px] sm:text-[10px] font-bold">üëë VIP</span>
                    </div>

                    <button id="btn-event"
                        class="rounded-lg sm:rounded-xl bg-gradient-to-r from-amber-500 to-orange-600 px-2 sm:px-4 py-1.5 sm:py-2 font-bold text-white text-xs sm:text-sm shadow-lg hover:scale-105 active:scale-95 transition-all animate-party"
                        onclick="game.planEvent()">
                        <div class="flex items-center gap-1 sm:gap-2">
                            <i class="ph-fill ph-confetti text-sm sm:text-base"></i>
                            <span class="hidden sm:inline">PARTY</span>
                        </div>
                    </button>
                </div>

                <!-- Now Playing Widget (hidden on mobile) -->
                <div id="now-playing-widget"
                    class="hidden sm:flex glass-panel px-3 py-1.5 rounded-full items-center gap-2 bg-black/60 backdrop-blur-md border border-white/10 transition-all duration-300 hover:bg-black/80 cursor-pointer"
                    onclick="openDJBooth()">
                    <div class="relative w-4 h-4 flex items-center justify-center">
                        <div class="absolute inset-0 bg-cyan-500/50 rounded-full animate-ping opacity-75"></div>
                        <i class="ph-fill ph-music-notes-simple text-cyan-400 text-[10px] relative z-10"></i>
                    </div>
                    <div class="flex flex-col leading-none text-right">
                        <span class="text-[8px] font-bold text-white/50 uppercase tracking-wider">NOW PLAYING</span>
                        <span class="text-[10px] font-bold text-cyan-400 truncate max-w-[120px]"
                            id="ui-track-name">None</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê NOTIFICATION AREA ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
        <div id="notification-area" class="fixed top-24 left-1/2 -translate-x-1/2 z-50 flex flex-col gap-2"></div>

        <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê LEFT SIDE PANEL (hidden on mobile) ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
        <div class="hidden md:flex fixed left-3 top-1/2 -translate-y-1/2 z-40 flex-col gap-2"
            style="pointer-events: auto;">
            <button class="glass-panel rounded-xl p-3 icon-btn hover:bg-white/10" id="btn-mode"
                onclick="game.toggleMode()">
                <i class="ph-fill ph-pencil-simple text-white text-xl"></i>
                <span class="text-[10px] text-gray-400 block mt-1">EDIT</span>
            </button>
            <button class="glass-panel rounded-xl p-3 icon-btn hover:bg-white/10" onclick="game.restockBar()">
                <i class="ph-fill ph-beer-bottle text-amber-400 text-xl"></i>
                <span class="text-[10px] text-gray-400 block mt-1">STOCK</span>
            </button>
        </div>


        <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê BOTTOM HUD ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
        <div class="fixed bottom-2 left-1 right-1 sm:left-2 sm:right-2 pointer-events-auto z-30">
            <!-- Mobile: Stacked layout, Desktop: Side-by-side -->

            <!-- Left: Stats -->
            <div class="hidden sm:flex absolute left-0 bottom-0 gap-1">
                <div class="glass-panel p-2 rounded-xl flex flex-col items-center w-14" id="stock-box">
                    <i class="ph-fill ph-martini text-orange-400 text-lg"></i>
                    <span class="text-sm font-bold text-white" id="stock-display">100%</span>
                </div>
                <div class="glass-panel p-2 rounded-xl flex flex-col items-center w-14">
                    <i class="ph-fill ph-fire text-red-500 text-lg"></i>
                    <span class="text-sm font-bold text-white" id="hype-display">0</span>
                </div>
            </div>

            <!-- Center Dock -->
            <div class="flex justify-center mx-0 sm:mx-32">
                <div class="glass-panel rounded-2xl p-1 sm:p-2 flex items-end gap-0 overflow-x-auto scrollbar-hide">

                    <!-- Mobile-only: Now Playing + Stats inline -->
                    <div class="flex sm:hidden items-center gap-1 px-1 border-r border-white/10 mr-1">
                        <!-- Now Playing indicator for mobile -->
                        <button class="flex flex-col items-center px-1" onclick="openDJBooth()">
                            <i class="ph-fill ph-music-notes text-cyan-400 text-xs animate-pulse"></i>
                            <span class="text-[8px] text-cyan-400 truncate max-w-[40px]"
                                id="ui-track-name-mobile">üéµ</span>
                        </button>
                        <div class="w-px h-4 bg-white/20"></div>
                        <div class="flex flex-col items-center" id="stock-box-mobile">
                            <i class="ph-fill ph-martini text-orange-400 text-xs"></i>
                            <span class="text-[10px] font-bold text-white" id="stock-display-mobile">100%</span>
                        </div>
                        <div class="flex flex-col items-center">
                            <i class="ph-fill ph-fire text-red-500 text-xs"></i>
                            <span class="text-[10px] font-bold text-white" id="hype-display-mobile">0</span>
                        </div>
                    </div>

                    <button
                        class="dock-btn flex flex-col items-center group px-1 sm:px-2 hover:-translate-y-1 transition-all flex-shrink-0"
                        onclick="game.openModal('shop')">
                        <div
                            class="w-9 h-9 sm:w-10 sm:h-10 rounded-xl bg-gradient-to-br from-blue-500 to-blue-700 flex items-center justify-center shadow-md">
                            <i class="ph-fill ph-shopping-cart text-lg sm:text-xl text-white"></i>
                        </div>
                        <span class="text-[6px] sm:text-[8px] font-bold opacity-70 mt-0.5">SHOP</span>
                    </button>

                    <button
                        class="dock-btn flex flex-col items-center group px-1 sm:px-2 hover:-translate-y-1 transition-all flex-shrink-0"
                        onclick="game.openModal('upgrade')">
                        <div
                            class="w-9 h-9 sm:w-10 sm:h-10 rounded-xl bg-gradient-to-br from-emerald-500 to-green-600 flex items-center justify-center shadow-md">
                            <i class="ph-fill ph-arrow-fat-up text-lg sm:text-xl text-white"></i>
                        </div>
                        <span class="text-[6px] sm:text-[8px] font-bold opacity-70 mt-0.5">UPG</span>
                    </button>

                    <!-- Restock -->
                    <div class="relative -top-1 sm:-top-2 px-0.5 flex-shrink-0">
                        <button id="restock-btn" title="Restock Bar"
                            class="w-10 h-10 sm:w-12 sm:h-12 rounded-xl bg-gradient-to-b from-amber-400 via-orange-500 to-red-600 flex items-center justify-center shadow-lg hover:scale-105 active:scale-95 transition-all animate-party"
                            onclick="game.restockBar()">
                            <i class="ph-fill ph-beer-bottle text-xl sm:text-2xl text-white"></i>
                        </button>
                    </div>

                    <button
                        class="dock-btn flex flex-col items-center group px-1 sm:px-2 hover:-translate-y-1 transition-all flex-shrink-0"
                        onclick="game.openModal('staff')">
                        <div
                            class="w-9 h-9 sm:w-10 sm:h-10 rounded-xl bg-gradient-to-br from-indigo-500 to-purple-600 flex items-center justify-center shadow-md">
                            <i class="ph-fill ph-users-three text-lg sm:text-xl text-white"></i>
                        </div>
                        <span class="text-[6px] sm:text-[8px] font-bold opacity-70 mt-0.5">STAFF</span>
                    </button>

                    <button
                        class="dock-btn flex flex-col items-center group px-1 sm:px-2 hover:-translate-y-1 transition-all flex-shrink-0"
                        onclick="game.openModal('dj')">
                        <div
                            class="w-9 h-9 sm:w-10 sm:h-10 rounded-xl bg-gradient-to-br from-pink-500 to-rose-600 flex items-center justify-center shadow-md">
                            <i class="ph-fill ph-music-notes text-lg sm:text-xl text-white"></i>
                        </div>
                        <span class="text-[6px] sm:text-[8px] font-bold opacity-70 mt-0.5">DJ</span>
                    </button>

                    <button id="daily-dock-btn"
                        class="dock-btn flex flex-col items-center group px-1 sm:px-2 hover:-translate-y-1 transition-all relative flex-shrink-0"
                        onclick="game.openModal('challenges'); refreshChallenges();">
                        <div
                            class="w-9 h-9 sm:w-10 sm:h-10 rounded-xl bg-gradient-to-br from-yellow-500 to-orange-600 flex items-center justify-center shadow-md">
                            <i class="ph-fill ph-gift text-lg sm:text-xl text-white"></i>
                        </div>
                        <span class="text-[6px] sm:text-[8px] font-bold opacity-70 mt-0.5">DAILY</span>
                        <span
                            class="daily-reward-badge hidden absolute -top-1 -right-1 bg-red-500 text-white text-[8px] font-bold min-w-[14px] h-3.5 rounded-full flex items-center justify-center px-0.5"
                            id="daily-dock-badge">!</span>
                    </button>

                    <button id="chat-dock-btn"
                        class="dock-btn flex flex-col items-center group px-1 sm:px-2 hover:-translate-y-1 transition-all relative flex-shrink-0"
                        onclick="chatSystem.toggleChat()">
                        <div
                            class="w-9 h-9 sm:w-10 sm:h-10 rounded-xl bg-gradient-to-br from-indigo-500 to-violet-600 flex items-center justify-center shadow-md">
                            <i class="ph-fill ph-chat-circle-dots text-lg sm:text-xl text-white"></i>
                        </div>
                        <span class="text-[6px] sm:text-[8px] font-bold opacity-70 mt-0.5">CHAT</span>
                        <span
                            class="chat-dock-badge hidden absolute -top-1 -right-1 bg-red-500 text-white text-[8px] font-bold min-w-[14px] h-3.5 rounded-full flex items-center justify-center px-0.5"
                            id="chat-dock-badge">0</span>
                    </button>

                    <button id="friends-dock-btn"
                        class="dock-btn flex flex-col items-center group px-1 sm:px-2 hover:-translate-y-1 transition-all relative flex-shrink-0"
                        onclick="toggleFriends()">
                        <div
                            class="w-9 h-9 sm:w-10 sm:h-10 rounded-xl bg-gradient-to-br from-purple-500 to-pink-600 flex items-center justify-center shadow-md">
                            <i class="ph-fill ph-users-three text-lg sm:text-xl text-white"></i>
                        </div>
                        <span class="text-[6px] sm:text-[8px] font-bold opacity-70 mt-0.5">SOCIAL</span>
                        <span
                            class="friends-dock-badge hidden absolute -top-1 -right-1 bg-red-500 text-white text-[8px] font-bold min-w-[14px] h-3.5 rounded-full flex items-center justify-center px-0.5"
                            id="friends-dock-badge">0</span>
                    </button>

                    <button id="world-dock-btn"
                        class="dock-btn flex flex-col items-center group px-1 sm:px-2 hover:-translate-y-1 transition-all relative flex-shrink-0"
                        onclick="goToWorld()" title="Enter Social World">
                        <div
                            class="w-9 h-9 sm:w-10 sm:h-10 rounded-xl bg-gradient-to-br from-cyan-500 to-blue-600 flex items-center justify-center shadow-md">
                            <i class="ph-fill ph-globe-hemisphere-west text-lg sm:text-xl text-white"></i>
                        </div>
                        <span class="text-[6px] sm:text-[8px] font-bold opacity-70 mt-0.5">WORLD</span>
                    </button>

                    <!-- Mobile-only: Edit button -->
                    <button
                        class="dock-btn md:hidden flex flex-col items-center group px-1 hover:-translate-y-1 transition-all flex-shrink-0"
                        onclick="game.toggleMode()">
                        <div
                            class="w-9 h-9 rounded-xl bg-gradient-to-br from-violet-500 to-purple-700 flex items-center justify-center shadow-md">
                            <i class="ph-fill ph-pencil-simple text-lg text-white"></i>
                        </div>
                        <span class="text-[6px] font-bold opacity-70 mt-0.5">EDIT</span>
                    </button>

                    <!-- Mobile-only: Settings/More button -->
                    <button
                        class="dock-btn md:hidden flex flex-col items-center group px-1 hover:-translate-y-1 transition-all flex-shrink-0"
                        onclick="game.openModal('settings')">
                        <div
                            class="w-9 h-9 rounded-xl bg-gradient-to-br from-gray-500 to-gray-700 flex items-center justify-center shadow-md">
                            <i class="ph-fill ph-gear text-lg text-white"></i>
                        </div>
                        <span class="text-[6px] font-bold opacity-70 mt-0.5">MORE</span>
                    </button>

                    <!-- Mobile-only: Guests inline -->
                    <div class="flex sm:hidden items-center gap-1 px-1.5 border-l border-white/10 ml-1">
                        <div class="flex -space-x-1">
                            <div class="w-4 h-4 rounded-full bg-blue-500 border border-black"></div>
                            <div class="w-4 h-4 rounded-full bg-purple-500 border border-black"></div>
                            <div
                                class="w-4 h-4 rounded-full bg-green-500 border border-black flex items-center justify-center text-[7px] font-bold">
                                +</div>
                        </div>
                        <div class="flex flex-col leading-none">
                            <span class="text-[7px] text-gray-400">GUESTS</span>
                            <span class="text-[10px] font-bold"><span id="guest-count-mobile">0</span>/<span
                                    id="max-guests-mobile" class="text-gray-400">20</span></span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Right: Report + Guests (hidden on mobile, shown on sm+) -->
            <div class="hidden sm:flex absolute right-0 bottom-0 items-center gap-1">
                <!-- Report Button -->
                <button class="glass-panel p-2 rounded-xl hover:bg-white/10 transition-colors"
                    onclick="openReportModal()" title="Submit a Report">
                    <i class="ph-fill ph-flag text-orange-400 text-lg"></i>
                </button>

                <!-- Guests -->
                <div class="glass-panel px-3 py-2 rounded-xl flex items-center gap-2">
                    <div class="flex -space-x-2">
                        <div class="w-6 h-6 rounded-full bg-blue-500 border border-black"></div>
                        <div class="w-6 h-6 rounded-full bg-purple-500 border border-black"></div>
                        <div
                            class="w-6 h-6 rounded-full bg-green-500 border border-black flex items-center justify-center text-[10px] font-bold">
                            +</div>
                    </div>
                    <div class="flex flex-col leading-none">
                        <span class="text-[9px] text-gray-400">GUESTS</span>
                        <span class="text-sm font-bold"><span id="guest-count">0</span>/<span id="max-guests"
                                class="text-gray-400">20</span></span>
                    </div>
                </div>
            </div>
        </div>

        <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê RIGHT SIDE: More Options (hidden on mobile) ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
        <div class="hidden md:flex fixed right-3 top-1/2 -translate-y-1/2 z-40 flex-col gap-2"
            style="pointer-events: auto;">
            <button class="glass-panel rounded-xl p-3 icon-btn hover:bg-white/10" onclick="game.openCelebrityModal()"
                title="Celebrities">
                <i class="ph-fill ph-star text-yellow-400 text-xl"></i>
            </button>
            <button class="glass-panel rounded-xl p-3 icon-btn hover:bg-white/10"
                onclick="game.openModal('challenges'); refreshChallenges();" title="Daily Rewards">
                <i class="ph-fill ph-gift text-yellow-400 text-xl"></i>
            </button>
            <button class="glass-panel rounded-xl p-3 icon-btn hover:bg-white/10" onclick="game.openModal('settings')"
                title="Settings">
                <i class="ph-fill ph-gear text-gray-400 text-xl"></i>
            </button>
        </div>


        <!-- Hidden elements for backward compatibility -->
        <div id="xp-bar-fill" class="hidden"></div>

    </div>

    <!-- Shop Modal -->
    <div id="shop-modal"
        class="modal-overlay hidden fixed inset-0 bg-black/70 backdrop-blur-sm z-[100] flex items-center justify-center p-4">
        <div class="glass-panel rounded-3xl w-full max-w-4xl max-h-[85vh] overflow-hidden flex flex-col font-display">
            <!-- Header -->
            <div class="flex items-center justify-between p-5 border-b border-white/10">
                <h2 class="text-2xl font-bold text-white flex items-center gap-3">
                    <i class="ph-fill ph-shopping-cart text-blue-400"></i>
                    FURNITURE SHOP
                </h2>
                <button
                    class="w-10 h-10 rounded-xl bg-white/10 hover:bg-red-500/50 flex items-center justify-center text-white transition-colors"
                    onclick="game.closeModals()" title="Close">
                    <i class="ph-bold ph-x text-xl"></i>
                </button>
            </div>
            <!-- Tabs -->
            <div class="flex gap-2 p-4 overflow-x-auto border-b border-white/10" id="furniture-tabs">
                <button
                    class="shop-tab px-4 py-2 rounded-xl bg-blue-500/30 text-blue-300 text-sm font-semibold whitespace-nowrap hover:bg-blue-500/50 transition-colors"
                    onclick="switchFurnitureTab('floors')">
                    <i class="ph-fill ph-squares-four mr-1"></i> Floors
                </button>
                <button
                    class="shop-tab px-4 py-2 rounded-xl bg-white/10 text-gray-300 text-sm font-semibold whitespace-nowrap hover:bg-white/20 transition-colors"
                    onclick="switchFurnitureTab('furniture')">
                    <i class="ph-fill ph-armchair mr-1"></i> Furniture
                </button>
                <button
                    class="shop-tab px-4 py-2 rounded-xl bg-white/10 text-gray-300 text-sm font-semibold whitespace-nowrap hover:bg-white/20 transition-colors"
                    onclick="switchFurnitureTab('seating')">
                    <i class="ph-fill ph-couch mr-1"></i> Seating
                </button>
                <button
                    class="shop-tab px-4 py-2 rounded-xl bg-white/10 text-gray-300 text-sm font-semibold whitespace-nowrap hover:bg-white/20 transition-colors"
                    onclick="switchFurnitureTab('entertainment')">
                    <i class="ph-fill ph-speaker-high mr-1"></i> Entertainment
                </button>
                <button
                    class="shop-tab px-4 py-2 rounded-xl bg-white/10 text-gray-300 text-sm font-semibold whitespace-nowrap hover:bg-white/20 transition-colors"
                    onclick="switchFurnitureTab('decor')">
                    <i class="ph-fill ph-flower-lotus mr-1"></i> Decor
                </button>
                <button
                    class="shop-tab px-4 py-2 rounded-xl bg-yellow-500/30 text-yellow-300 text-sm font-semibold whitespace-nowrap hover:bg-yellow-500/50 transition-colors"
                    onclick="switchFurnitureTab('lights')">
                    <i class="ph-fill ph-lightbulb-filament mr-1"></i> Lights
                </button>
                <button
                    class="shop-tab px-4 py-2 rounded-xl bg-purple-500/30 text-purple-300 text-sm font-semibold whitespace-nowrap hover:bg-purple-500/50 transition-colors"
                    onclick="switchFurnitureTab('premium')">
                    <i class="ph-fill ph-diamond mr-1"></i> Premium
                </button>
            </div>
            <!-- Currency Display -->
            <div class="flex gap-4 px-5 py-3 bg-black/20">
                <div class="flex items-center gap-2 bg-green-500/20 px-4 py-2 rounded-xl">
                    <i class="ph-fill ph-coins text-green-400"></i>
                    <span class="text-green-400 font-bold">$<span id="shop-cash">0</span></span>
                </div>
                <div class="flex items-center gap-2 bg-purple-500/20 px-4 py-2 rounded-xl">
                    <i class="ph-fill ph-diamond text-purple-400"></i>
                    <span class="text-purple-400 font-bold"><span id="shop-diamonds">0</span></span>
                </div>
            </div>
            <!-- Grid -->
            <div class="flex-1 overflow-y-auto p-5">
                <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-4" id="shop-grid">
                    <!-- Populated by JS -->
                </div>
            </div>
        </div>
    </div>

    <!-- Upgrades Modal -->
    <div id="upgrade-modal"
        class="modal-overlay hidden fixed inset-0 bg-black/70 backdrop-blur-sm z-[100] flex items-center justify-center p-4">
        <div class="glass-panel rounded-3xl w-full max-w-lg overflow-hidden font-display">
            <!-- Header -->
            <div class="flex items-center justify-between p-5 border-b border-white/10">
                <h2 class="text-2xl font-bold text-white flex items-center gap-3">
                    <i class="ph-fill ph-arrow-circle-up text-green-400"></i>
                    UPGRADES
                </h2>
                <button
                    class="w-10 h-10 rounded-xl bg-white/10 hover:bg-red-500/50 flex items-center justify-center text-white transition-colors"
                    onclick="game.closeModals()" title="Close">
                    <i class="ph-bold ph-x text-xl"></i>
                </button>
            </div>
            <!-- Upgrade List -->
            <div class="p-5 space-y-4">
                <div
                    class="flex items-center justify-between p-4 bg-white/5 rounded-2xl hover:bg-white/10 transition-colors">
                    <div class="flex items-center gap-4">
                        <div class="w-12 h-12 rounded-xl bg-blue-500/30 flex items-center justify-center">
                            <i class="ph-fill ph-house text-blue-400 text-2xl"></i>
                        </div>
                        <div>
                            <div class="text-white font-bold">Expand Space</div>
                            <div class="text-xs text-purple-400" id="cap-level">Level 1</div>
                            <div class="text-xs text-gray-400">Max Capacity +5 guests</div>
                        </div>
                    </div>
                    <button
                        class="gradient-cash px-5 py-2 rounded-xl text-white font-bold hover:scale-105 transition-transform"
                        id="upg-cap" onclick="game.buyUpgrade('capacity')">$500</button>
                </div>
                <div
                    class="flex items-center justify-between p-4 bg-white/5 rounded-2xl hover:bg-white/10 transition-colors">
                    <div class="flex items-center gap-4">
                        <div class="w-12 h-12 rounded-xl bg-orange-500/30 flex items-center justify-center">
                            <i class="ph-fill ph-megaphone text-orange-400 text-2xl"></i>
                        </div>
                        <div>
                            <div class="text-white font-bold">Marketing</div>
                            <div class="text-xs text-purple-400" id="mkt-level">Level 1</div>
                            <div class="text-xs text-gray-400">Faster guest arrivals</div>
                        </div>
                    </div>
                    <button
                        class="gradient-cash px-5 py-2 rounded-xl text-white font-bold hover:scale-105 transition-transform"
                        id="upg-spawn" onclick="game.buyUpgrade('marketing')">$300</button>
                </div>
                <div
                    class="flex items-center justify-between p-4 bg-white/5 rounded-2xl hover:bg-white/10 transition-colors">
                    <div class="flex items-center gap-4">
                        <div class="w-12 h-12 rounded-xl bg-pink-500/30 flex items-center justify-center">
                            <i class="ph-fill ph-champagne text-pink-400 text-2xl"></i>
                        </div>
                        <div>
                            <div class="text-white font-bold">Premium Drinks</div>
                            <div class="text-xs text-purple-400" id="prf-level">Level 1</div>
                            <div class="text-xs text-gray-400">+20% drink profits</div>
                        </div>
                    </div>
                    <button
                        class="gradient-cash px-5 py-2 rounded-xl text-white font-bold hover:scale-105 transition-transform"
                        id="upg-profit" onclick="game.buyUpgrade('profit')">$400</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Event Modal -->
    <div id="event-modal"
        class="modal-overlay hidden fixed inset-0 bg-black/70 backdrop-blur-sm z-[100] flex items-center justify-center p-4">
        <div class="glass-panel rounded-3xl w-full max-w-md overflow-hidden font-display text-center">
            <!-- Header -->
            <div class="flex items-center justify-between p-5 border-b border-white/10">
                <h2 class="text-2xl font-bold text-white flex items-center gap-3">
                    <i class="ph-fill ph-confetti text-yellow-400"></i>
                    SPECIAL EVENT
                </h2>
                <button
                    class="w-10 h-10 rounded-xl bg-white/10 hover:bg-red-500/50 flex items-center justify-center text-white transition-colors"
                    onclick="game.closeModals()" title="Close">
                    <i class="ph-bold ph-x text-xl"></i>
                </button>
            </div>
            <!-- Content -->
            <div class="p-8 space-y-6">
                <div class="text-3xl font-bold text-white" id="event-title">Theme Night</div>
                <div class="text-gray-300" id="event-desc">Get ready for the hottest party!</div>
                <div class="text-2xl font-bold text-green-400 animate-pulse" id="event-bonus">üí∞ 2x CASH BONUS! üí∞</div>
                <button
                    class="gradient-party w-full py-4 rounded-2xl text-white text-xl font-bold hover:scale-105 transition-transform"
                    onclick="game.closeModals()">
                    <i class="ph-fill ph-confetti mr-2"></i>
                    LET'S PARTY!
                </button>
            </div>
        </div>
    </div>

    <!-- Staff Modal -->
    <div id="staff-modal"
        class="modal-overlay hidden fixed inset-0 bg-black/70 backdrop-blur-sm z-[100] flex items-center justify-center p-4">
        <div class="glass-panel rounded-3xl w-full max-w-lg overflow-hidden font-display">
            <!-- Header -->
            <div class="flex items-center justify-between p-5 border-b border-white/10">
                <h2 class="text-2xl font-bold text-white flex items-center gap-3">
                    <i class="ph-fill ph-users-three text-purple-400"></i>
                    HIRE STAFF
                </h2>
                <button
                    class="w-10 h-10 rounded-xl bg-white/10 hover:bg-red-500/50 flex items-center justify-center text-white transition-colors"
                    onclick="game.closeModals()" title="Close">
                    <i class="ph-bold ph-x text-xl"></i>
                </button>
            </div>
            <!-- Staff List -->
            <div class="p-5 space-y-3 max-h-[60vh] overflow-y-auto" id="staff-list">
                <!-- Populated by JS -->
            </div>
        </div>
    </div>

    <!-- Friends Modal -->
    <div id="friends-modal"
        class="modal-overlay hidden fixed inset-0 bg-black/70 backdrop-blur-sm z-[9500] flex items-center justify-center p-4"
        onclick="if(event.target===this) this.classList.add('hidden')">
        <div class="glass-panel rounded-3xl w-full max-w-lg overflow-hidden font-display">
            <!-- Header -->
            <div class="flex items-center justify-between p-5 border-b border-white/10">
                <h2 class="text-2xl font-bold text-white flex items-center gap-3">
                    <i class="ph-fill ph-users text-cyan-400"></i>
                    FRIENDS
                </h2>
                <button
                    class="w-10 h-10 rounded-xl bg-white/10 hover:bg-red-500/50 flex items-center justify-center text-white transition-colors"
                    onclick="document.getElementById('friends-modal').classList.add('hidden')" title="Close">
                    <i class="ph-bold ph-x text-xl"></i>
                </button>
            </div>
            <!-- Friends List -->
            <div class="p-5 space-y-3 max-h-[60vh] overflow-y-auto" id="friends-list">
                <!-- Populated by JS -->
            </div>
        </div>
    </div>

    <!-- Visit Club Modal -->
    <div id="visit-club-modal"
        class="modal-overlay hidden fixed inset-0 bg-black/85 backdrop-blur-md z-[9600] flex items-center justify-center p-4">
        <div class="visit-club-container">
            <!-- Close Button -->
            <button class="visit-close-btn" onclick="closeVisitClubModal()" title="Close">
                <i class="ph-bold ph-x"></i>
            </button>

            <!-- Club Preview Header -->
            <div class="visit-club-header">
                <div class="visit-club-banner" id="visit-club-banner">
                    <div class="visit-club-banner-overlay"></div>
                    <div class="visit-live-badge">
                        <span class="live-dot"></span> LIVE
                    </div>
                </div>

                <div class="visit-club-info">
                    <div class="visit-club-avatar" id="visit-club-avatar">üè¢</div>
                    <div class="visit-club-details">
                        <h2 class="visit-club-name" id="visit-club-name">Club Name</h2>
                        <p class="visit-club-owner" id="visit-club-owner">by Owner Name</p>
                        <div class="visit-club-level" id="visit-club-level">
                            <i class="ph-fill ph-star"></i> Level 1
                        </div>
                    </div>
                </div>
            </div>

            <!-- Live Stats -->
            <div class="visit-stats-grid">
                <div class="visit-stat">
                    <i class="ph-fill ph-users stat-icon guests"></i>
                    <div class="stat-content">
                        <span class="stat-value" id="visit-guests">0</span>
                        <span class="stat-label">Guests</span>
                    </div>
                </div>
                <div class="visit-stat">
                    <i class="ph-fill ph-fire stat-icon hype"></i>
                    <div class="stat-content">
                        <span class="stat-value" id="visit-hype">0</span>
                        <span class="stat-label">Hype</span>
                    </div>
                </div>
                <div class="visit-stat">
                    <i class="ph-fill ph-armchair stat-icon furniture"></i>
                    <div class="stat-content">
                        <span class="stat-value" id="visit-furniture">0</span>
                        <span class="stat-label">Furniture</span>
                    </div>
                </div>
                <div class="visit-stat">
                    <i class="ph-fill ph-currency-dollar stat-icon earnings"></i>
                    <div class="stat-content">
                        <span class="stat-value" id="visit-earnings">$0</span>
                        <span class="stat-label">Earnings</span>
                    </div>
                </div>
            </div>

            <!-- Club Preview Area -->
            <div class="visit-preview-area" id="visit-preview-area">
                <div class="visit-preview-placeholder">
                    <i class="ph-fill ph-buildings"></i>
                    <p>Loading club preview...</p>
                </div>
            </div>

            <!-- Activity Feed -->
            <div class="visit-activity">
                <h3><i class="ph-fill ph-lightning"></i> Live Activity</h3>
                <div class="visit-activity-feed" id="visit-activity-feed">
                    <!-- Populated by JS -->
                </div>
            </div>

            <!-- Action Buttons -->
            <div class="visit-actions">
                <button class="visit-action-btn fullscreen" onclick="enterFullscreenVisit()">
                    <i class="ph-fill ph-eye"></i>
                    <span>Preview Club</span>
                </button>
                <button class="visit-action-btn gift" onclick="sendGiftToFriend()" title="Send Gift">
                    <i class="ph-fill ph-gift"></i>
                    <span>Send Gift</span>
                </button>
                <button class="visit-action-btn back" onclick="closeVisitClubModal()" title="Go Back">
                    <i class="ph-fill ph-arrow-left"></i>
                    <span>Go Back</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Achievements Modal -->
    <div id="achievements-modal"
        class="modal-overlay hidden fixed inset-0 bg-black/70 backdrop-blur-sm z-[9500] flex items-center justify-center p-4">
        <div class="glass-panel rounded-3xl w-full max-w-lg overflow-hidden font-display">
            <div class="flex items-center justify-between p-5 border-b border-white/10">
                <h2 class="text-2xl font-bold text-white flex items-center gap-3">
                    <i class="ph-fill ph-trophy text-yellow-400"></i>
                    ACHIEVEMENTS
                </h2>
                <button
                    class="w-10 h-10 rounded-xl bg-white/10 hover:bg-red-500/50 flex items-center justify-center text-white transition-colors"
                    onclick="game.closeModals()" title="Close">
                    <i class="ph-bold ph-x text-xl"></i>
                </button>
            </div>
            <div class="p-5 space-y-3 max-h-[60vh] overflow-y-auto" id="achievements-list">
                <!-- Populated by JS -->
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div id="settings-modal"
        class="modal-overlay hidden fixed inset-0 bg-black/80 backdrop-blur-md z-[100] flex items-center justify-center p-4"
        onclick="if(event.target===this) game.closeModals()">
        <div class="glass-panel rounded-3xl w-full max-w-lg overflow-hidden font-display shadow-2xl border border-white/10"
            style="max-height: 90vh;">
            <!-- Header -->
            <div
                class="relative bg-gradient-to-r from-indigo-600/20 via-purple-600/20 to-pink-600/20 p-5 border-b border-white/10">
                <div class="absolute inset-0 bg-gradient-to-b from-white/5 to-transparent"></div>
                <div class="relative flex items-center justify-between">
                    <h2 class="text-2xl font-bold text-white flex items-center gap-3">
                        <div class="w-10 h-10 rounded-xl bg-white/10 flex items-center justify-center">
                            <i class="ph-fill ph-gear-six text-xl text-white"></i>
                        </div>
                        Settings
                    </h2>
                    <button
                        class="w-10 h-10 rounded-xl bg-white/10 hover:bg-red-500/50 flex items-center justify-center text-white transition-all hover:scale-105"
                        onclick="game.closeModals()" title="Close">
                        <i class="ph-bold ph-x text-xl"></i>
                    </button>
                </div>
            </div>

            <!-- Scrollable Content -->
            <div class="p-5 space-y-5 overflow-y-auto" style="max-height: calc(90vh - 80px);">

                <!-- Audio & Display Section -->
                <div class="space-y-2">
                    <div class="text-xs font-bold text-slate-400 uppercase tracking-wider px-1 flex items-center gap-2">
                        <i class="ph-fill ph-sliders text-indigo-400"></i> Audio & Display
                    </div>
                    <div class="bg-white/5 rounded-2xl p-1 space-y-1">
                        <div
                            class="flex items-center justify-between p-3 rounded-xl hover:bg-white/5 transition-colors">
                            <span class="text-white flex items-center gap-3 text-sm">
                                <div class="w-8 h-8 rounded-lg bg-green-500/20 flex items-center justify-center">
                                    <i class="ph-fill ph-monitor text-green-400"></i>
                                </div>
                                Graphics
                            </span>
                            <select id="graphics-quality" title="Graphics Quality"
                                class="px-3 py-1.5 rounded-lg bg-black/40 text-white font-medium text-xs border border-white/10 cursor-pointer focus:outline-none focus:border-indigo-500"
                                onchange="setGraphicsQuality(this.value)">
                                <option value="low">üîã Low</option>
                                <option value="medium">‚öñÔ∏è Medium</option>
                                <option value="high" selected>‚ú® High</option>
                            </select>
                        </div>
                        <div
                            class="flex items-center justify-between p-3 rounded-xl hover:bg-white/5 transition-colors">
                            <span class="text-white flex items-center gap-3 text-sm">
                                <div class="w-8 h-8 rounded-lg bg-blue-500/20 flex items-center justify-center">
                                    <i class="ph-fill ph-speaker-high text-blue-400"></i>
                                </div>
                                Sound FX
                            </span>
                            <button
                                class="w-16 py-1.5 rounded-lg bg-emerald-500/20 text-emerald-400 font-bold text-xs border border-emerald-500/30 hover:bg-emerald-500/30 transition-colors"
                                id="sound-toggle" onclick="game.toggleSound()">ON</button>
                        </div>
                        <div
                            class="flex items-center justify-between p-3 rounded-xl hover:bg-white/5 transition-colors">
                            <span class="text-white flex items-center gap-3 text-sm">
                                <div class="w-8 h-8 rounded-lg bg-pink-500/20 flex items-center justify-center">
                                    <i class="ph-fill ph-music-notes text-pink-400"></i>
                                </div>
                                Music
                            </span>
                            <button
                                class="w-16 py-1.5 rounded-lg bg-emerald-500/20 text-emerald-400 font-bold text-xs border border-emerald-500/30 hover:bg-emerald-500/30 transition-colors"
                                id="music-toggle" onclick="game.toggleMusic()">ON</button>
                        </div>
                    </div>
                </div>

                <!-- Game Info Section -->
                <div class="space-y-2">
                    <div class="text-xs font-bold text-slate-400 uppercase tracking-wider px-1 flex items-center gap-2">
                        <i class="ph-fill ph-game-controller text-purple-400"></i> Game Info
                    </div>
                    <div class="grid grid-cols-3 gap-2">
                        <button onclick="game.closeModals(); game.openModal('achievements'); refreshAchievements();"
                            class="flex flex-col items-center gap-2 p-4 bg-white/5 rounded-2xl hover:bg-yellow-500/10 border border-transparent hover:border-yellow-500/30 transition-all group">
                            <div
                                class="w-10 h-10 rounded-xl bg-yellow-500/20 flex items-center justify-center group-hover:scale-110 transition-transform">
                                <i class="ph-fill ph-trophy text-yellow-400 text-xl"></i>
                            </div>
                            <span class="text-white text-xs font-medium">Achievements</span>
                        </button>
                        <button onclick="game.closeModals(); game.openModal('challenges'); refreshChallenges();"
                            class="flex flex-col items-center gap-2 p-4 bg-white/5 rounded-2xl hover:bg-orange-500/10 border border-transparent hover:border-orange-500/30 transition-all group">
                            <div
                                class="w-10 h-10 rounded-xl bg-orange-500/20 flex items-center justify-center group-hover:scale-110 transition-transform">
                                <i class="ph-fill ph-list-checks text-orange-400 text-xl"></i>
                            </div>
                            <span class="text-white text-xs font-medium">Challenges</span>
                        </button>
                        <button onclick="game.closeModals(); game.openModal('stats'); refreshStats();"
                            class="flex flex-col items-center gap-2 p-4 bg-white/5 rounded-2xl hover:bg-cyan-500/10 border border-transparent hover:border-cyan-500/30 transition-all group">
                            <div
                                class="w-10 h-10 rounded-xl bg-cyan-500/20 flex items-center justify-center group-hover:scale-110 transition-transform">
                                <i class="ph-fill ph-chart-bar text-cyan-400 text-xl"></i>
                            </div>
                            <span class="text-white text-xs font-medium">Statistics</span>
                        </button>
                    </div>
                </div>

                <!-- Redeem Code Section -->
                <div class="space-y-2">
                    <div class="text-xs font-bold text-slate-400 uppercase tracking-wider px-1 flex items-center gap-2">
                        <i class="ph-fill ph-gift text-yellow-400"></i> Rewards
                    </div>
                    <button onclick="game.openRedeemModal()"
                        class="w-full p-4 bg-gradient-to-r from-yellow-500/10 via-amber-500/10 to-orange-500/10 rounded-2xl border border-yellow-500/20 hover:border-yellow-500/40 transition-all group">
                        <div class="flex items-center gap-4">
                            <div
                                class="w-12 h-12 rounded-xl bg-gradient-to-br from-yellow-500 to-amber-500 flex items-center justify-center shadow-lg group-hover:scale-110 transition-transform">
                                <i class="ph-fill ph-gift text-white text-2xl"></i>
                            </div>
                            <div class="flex-1 text-left">
                                <div class="text-white font-bold">Redeem Gift Code</div>
                                <div class="text-yellow-400/70 text-xs">Enter a code to claim rewards!</div>
                            </div>
                            <i
                                class="ph-bold ph-caret-right text-yellow-400 text-xl group-hover:translate-x-1 transition-transform"></i>
                        </div>
                    </button>
                </div>

                <!-- Data Section -->
                <div class="space-y-2">
                    <div class="text-xs font-bold text-slate-400 uppercase tracking-wider px-1 flex items-center gap-2">
                        <i class="ph-fill ph-database text-slate-400"></i> Data
                    </div>
                    <div class="grid grid-cols-2 gap-2">
                        <button onclick="game.manualSave()"
                            class="flex items-center gap-3 p-3 bg-purple-500/10 rounded-xl border border-purple-500/20 hover:bg-purple-500/20 hover:border-purple-500/40 transition-all group">
                            <div
                                class="w-9 h-9 rounded-lg bg-purple-500/20 flex items-center justify-center group-hover:scale-110 transition-transform">
                                <i class="ph-fill ph-floppy-disk text-purple-400"></i>
                            </div>
                            <div class="text-left">
                                <div class="text-white text-sm font-medium">Save Game</div>
                                <div class="text-purple-400/60 text-[10px]">Save progress now</div>
                            </div>
                        </button>
                        <button onclick="game.resetGame()"
                            class="flex items-center gap-3 p-3 bg-red-500/10 rounded-xl border border-red-500/20 hover:bg-red-500/20 hover:border-red-500/40 transition-all group">
                            <div
                                class="w-9 h-9 rounded-lg bg-red-500/20 flex items-center justify-center group-hover:scale-110 transition-transform">
                                <i class="ph-fill ph-trash text-red-400"></i>
                            </div>
                            <div class="text-left">
                                <div class="text-white text-sm font-medium">Reset</div>
                                <div class="text-red-400/60 text-[10px]">Delete all data</div>
                            </div>
                        </button>
                    </div>
                </div>

                <!-- Version Info -->
                <div class="text-center pt-2 border-t border-white/5">
                    <div class="text-[10px] text-slate-500">Nightclub Tycoon ‚Ä¢ Made with ‚ù§Ô∏è</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Redeem Code Modal -->
    <div id="redeem-modal"
        class="modal-overlay hidden fixed inset-0 bg-black/70 backdrop-blur-sm z-[100] flex items-center justify-center p-4">
        <div class="glass-panel rounded-3xl w-full max-w-md overflow-hidden font-display">
            <div class="flex items-center justify-between p-5 border-b border-white/10">
                <h2 class="text-2xl font-bold text-white flex items-center gap-3">
                    <i class="ph-fill ph-gift text-yellow-400"></i>
                    REDEEM CODE
                </h2>
                <button
                    class="w-10 h-10 rounded-xl bg-white/10 hover:bg-red-500/50 flex items-center justify-center text-white transition-colors"
                    onclick="game.closeRedeemModal()" title="Close">
                    <i class="ph-bold ph-x text-xl"></i>
                </button>
            </div>
            <div class="p-5 space-y-4">
                <div class="text-sm text-gray-400 text-center">Enter a gift code to claim your rewards!</div>
                <div class="relative">
                    <input type="text" id="redeem-code-input" placeholder="XXXX-XXXX-XXXX"
                        class="w-full bg-black/30 border-2 border-yellow-500/30 rounded-xl px-4 py-4 text-white text-center text-xl font-mono uppercase tracking-widest focus:outline-none focus:border-yellow-500 placeholder-gray-600"
                        maxlength="20" autocomplete="off" spellcheck="false">
                </div>
                <div id="redeem-status" class="text-center text-sm hidden"></div>
                <button onclick="game.redeemCode()" id="redeem-btn"
                    class="w-full py-4 rounded-xl bg-gradient-to-r from-yellow-600 to-amber-600 hover:from-yellow-500 hover:to-amber-500 text-white font-bold text-lg flex items-center justify-center gap-2 transition-all disabled:opacity-50 disabled:cursor-not-allowed">
                    <i class="ph-fill ph-gift"></i> Redeem
                </button>
                <div class="text-center text-xs text-gray-500">Gift codes are case-insensitive</div>
            </div>
        </div>
    </div>

    <!-- Badge Shop Modal -->
    <div id="badge-shop-modal"
        class="modal-overlay hidden fixed inset-0 bg-black/70 backdrop-blur-sm z-[100] flex items-center justify-center p-4">
        <div class="glass-panel rounded-3xl w-full max-w-2xl overflow-hidden font-display">
            <div class="flex items-center justify-between p-5 border-b border-white/10">
                <h2 class="text-2xl font-bold text-white flex items-center gap-3">
                    <i class="ph-fill ph-star text-yellow-400"></i>
                    BADGE SHOP
                </h2>
                <button
                    class="w-10 h-10 rounded-xl bg-white/10 hover:bg-red-500/50 flex items-center justify-center text-white transition-colors"
                    onclick="game.closeModals()" title="Close">
                    <i class="ph-bold ph-x text-xl"></i>
                </button>
            </div>
            <div class="p-5">
                <div class="text-sm text-gray-400 mb-4">Customize your club badge seen by other players!</div>
                <div class="grid grid-cols-2 md:grid-cols-3 gap-4 max-h-[60vh] overflow-y-auto pr-2" id="badge-list">
                    <!-- Badges will be populated here via JS -->
                </div>
            </div>
        </div>
    </div>

    <!-- Challenges Modal -->
    <div id="challenges-modal"
        class="modal-overlay hidden fixed inset-0 bg-black/70 backdrop-blur-sm z-[100] flex items-center justify-center p-4"
        onclick="if(event.target===this) this.classList.add('hidden')">
        <div class="glass-panel rounded-3xl w-full max-w-lg overflow-hidden font-display">
            <div class="flex items-center justify-between p-5 border-b border-white/10">
                <h2 class="text-2xl font-bold text-white flex items-center gap-3">
                    <i class="ph-fill ph-gift text-yellow-400"></i>
                    DAILY REWARDS
                </h2>
                <button
                    class="w-10 h-10 rounded-xl bg-white/10 hover:bg-red-500/50 flex items-center justify-center text-white transition-colors"
                    onclick="document.getElementById('challenges-modal').classList.add('hidden')" title="Close">
                    <i class="ph-bold ph-x text-xl"></i>
                </button>
            </div>
            <div class="p-5 space-y-3 max-h-[60vh] overflow-y-auto" id="challenges-list">
                <!-- Populated by JS -->
            </div>
        </div>
    </div>

    <!-- Statistics Modal -->
    <div id="stats-modal"
        class="modal-overlay hidden fixed inset-0 bg-black/70 backdrop-blur-sm z-[100] flex items-center justify-center p-4">
        <div class="glass-panel rounded-3xl w-full max-w-md overflow-hidden font-display">
            <div class="flex items-center justify-between p-5 border-b border-white/10">
                <h2 class="text-2xl font-bold text-white flex items-center gap-3">
                    <i class="ph-fill ph-chart-bar text-cyan-400"></i>
                    STATISTICS
                </h2>
                <button
                    class="w-10 h-10 rounded-xl bg-white/10 hover:bg-red-500/50 flex items-center justify-center text-white transition-colors"
                    onclick="game.closeModals()" title="Close">
                    <i class="ph-bold ph-x text-xl"></i>
                </button>
            </div>
            <div class="p-5" id="stats-content">
                <!-- Populated by JS -->
            </div>
        </div>
    </div>

    <!-- Report/Feedback Modal -->
    <div id="report-modal"
        class="modal-overlay hidden fixed inset-0 bg-black/80 backdrop-blur-md z-[100] flex items-center justify-center p-4"
        onclick="if(event.target===this) closeReportModal()">
        <div
            class="glass-panel rounded-3xl w-full max-w-lg overflow-hidden font-display shadow-2xl border border-white/10">
            <div
                class="flex items-center justify-between p-5 border-b border-white/10 bg-gradient-to-r from-orange-600/20 to-red-600/20">
                <h2 class="text-2xl font-bold text-white flex items-center gap-3">
                    <i class="ph-fill ph-flag text-orange-400"></i>
                    SUBMIT A REPORT
                </h2>
                <button
                    class="w-10 h-10 rounded-xl bg-white/10 hover:bg-red-500/50 flex items-center justify-center text-white transition-colors"
                    onclick="closeReportModal()" title="Close">
                    <i class="ph-bold ph-x text-xl"></i>
                </button>
            </div>
            <div class="p-5 space-y-4">
                <p class="text-gray-400 text-sm">Help us improve Hypeclub City! Report bugs, suggest features, or share
                    feedback.</p>

                <!-- Report Type -->
                <div>
                    <label class="block text-sm font-medium text-white mb-2">Report Type</label>
                    <select id="report-type"
                        class="w-full bg-white/10 border border-white/20 rounded-xl px-4 py-3 text-white focus:outline-none focus:ring-2 focus:ring-orange-500/50">
                        <option value="bug">üêõ Bug Report</option>
                        <option value="feature">üí° Feature Request</option>
                        <option value="feedback">üí¨ General Feedback</option>
                        <option value="player">üö´ Report a Player</option>
                        <option value="other">üìù Other</option>
                    </select>
                </div>

                <!-- Subject -->
                <div>
                    <label class="block text-sm font-medium text-white mb-2">Subject</label>
                    <input type="text" id="report-subject" placeholder="Brief description..."
                        class="w-full bg-white/10 border border-white/20 rounded-xl px-4 py-3 text-white placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-orange-500/50">
                </div>

                <!-- Description -->
                <div>
                    <label class="block text-sm font-medium text-white mb-2">Description</label>
                    <textarea id="report-description" rows="4" placeholder="Please provide details..."
                        class="w-full bg-white/10 border border-white/20 rounded-xl px-4 py-3 text-white placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-orange-500/50 resize-none"></textarea>
                </div>

                <!-- Submit Button -->
                <button onclick="submitReport()"
                    class="w-full py-3 rounded-xl bg-gradient-to-r from-orange-500 to-red-500 text-white font-bold hover:opacity-90 transition-opacity flex items-center justify-center gap-2">
                    <i class="ph-fill ph-paper-plane-tilt"></i>
                    Submit Report
                </button>

                <p class="text-xs text-gray-500 text-center">Your report will be reviewed by our team. Thank you for
                    helping improve the game!</p>
            </div>
        </div>
    </div>

    <!-- DJ Booth Modal - Turntable Style -->
    <div id="dj-modal" class="modal-overlay hidden">
        <div class="modal-content modal-large dj-booth-modal">
            <div class="modal-header dj-header">
                <h2 class="modal-title">üéß DJ BOOTH</h2>
                <button class="modal-close" onclick="game.closeModals()">‚úï</button>
            </div>

            <div class="turntable-container">
                <!-- Turntable Deck -->
                <div class="turntable-deck">
                    <!-- Left Turntable -->
                    <div class="turntable" id="turntable-left">
                        <div class="platter">
                            <div class="vinyl" id="vinyl-left">
                                <div class="vinyl-label">
                                    <div class="vinyl-center"></div>
                                </div>
                                <div class="vinyl-grooves"></div>
                            </div>
                        </div>
                        <div class="tonearm"></div>
                    </div>

                    <!-- Mixer Center -->
                    <div class="mixer-panel">
                        <div class="mixer-display" id="youtube-now-playing">
                            <div class="now-playing-text">üéµ NOW PLAYING</div>
                            <div class="track-title" id="current-track-title">Loading...</div>
                        </div>

                        <div class="mixer-controls">
                            <div class="fader-group">
                                <label>VOLUME</label>
                                <input type="range" id="yt-volume" class="vertical-fader" min="0" max="100" value="50"
                                    title="Volume" onchange="djSystem.setYouTubeVolume(this.value)">
                                <span id="volume-display">50</span>
                            </div>

                            <div class="mixer-buttons">
                                <button class="deck-btn play-btn" onclick="djSystem.ytPlayer?.playVideo()">‚ñ∂</button>
                                <button class="deck-btn pause-btn" onclick="djSystem.ytPlayer?.pauseVideo()">‚è∏</button>
                                <button class="deck-btn skip-btn" onclick="djSystem.skipYouTube()">‚è≠</button>
                            </div>

                            <div class="mood-meter">
                                <label>CROWD</label>
                                <div class="led-meter">
                                    <div class="led"></div>
                                    <div class="led"></div>
                                    <div class="led"></div>
                                    <div class="led"></div>
                                    <div class="led"></div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Right Turntable -->
                    <div class="turntable" id="turntable-right">
                        <div class="platter">
                            <div class="vinyl" id="vinyl-right">
                                <div class="vinyl-label">
                                    <div class="vinyl-center"></div>
                                </div>
                                <div class="vinyl-grooves"></div>
                            </div>
                        </div>
                        <div class="tonearm"></div>
                    </div>
                </div>

                <!-- Default Club Music Section -->
                <div class="club-music-panel"
                    style="background: rgba(0,0,0,0.4); border-radius: 10px; padding: 12px; margin-bottom: 15px;">
                    <div
                        style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                        <span style="color: #00ff88; font-weight: bold; font-size: 14px;">üéµ CLUB MUSIC</span>
                        <input type="range" id="bg-music-volume" min="0" max="100" value="50" title="Volume"
                            style="width: 80px;" onchange="setBgVolume(this.value/100)">
                    </div>
                    <div id="club-music-tracks" style="display: flex; gap: 8px; flex-wrap: wrap;">
                        <button class="club-track-btn" onclick="playBgTrack(0)"
                            style="flex: 1; min-width: 60px; padding: 8px; background: linear-gradient(135deg, #ff6b6b, #ee5a5a); border: none; border-radius: 8px; color: white; font-weight: bold; cursor: pointer;">Mix
                            1</button>
                        <button class="club-track-btn" onclick="playBgTrack(1)"
                            style="flex: 1; min-width: 60px; padding: 8px; background: linear-gradient(135deg, #4ecdc4, #44a08d); border: none; border-radius: 8px; color: white; font-weight: bold; cursor: pointer;">Mix
                            2</button>
                        <button class="club-track-btn" onclick="playBgTrack(2)"
                            style="flex: 1; min-width: 60px; padding: 8px; background: linear-gradient(135deg, #a78bfa, #8b5cf6); border: none; border-radius: 8px; color: white; font-weight: bold; cursor: pointer;">Mix
                            3</button>
                        <button class="club-track-btn" onclick="playBgTrack(3)"
                            style="flex: 1; min-width: 60px; padding: 8px; background: linear-gradient(135deg, #fbbf24, #f59e0b); border: none; border-radius: 8px; color: white; font-weight: bold; cursor: pointer;">Mix
                            4</button>
                        <button class="club-track-btn" onclick="stopBgMusic()"
                            style="flex: 1; min-width: 40px; padding: 8px; background: #333; border: none; border-radius: 8px; color: #ff4444; font-weight: bold; cursor: pointer;">‚èπ</button>
                    </div>
                </div>

                <!-- Add Track Section -->
                <div class="add-track-panel">
                    <div class="youtube-add-form">
                        <input type="text" id="youtube-url-input" class="yt-url-input"
                            placeholder="üîó Paste YouTube URL to queue...">
                        <button class="yt-add-btn" onclick="addYouTubeTrack()">+ ADD</button>
                    </div>
                    <div class="queue-limits">
                        <span class="limit-tag">FREE: 2</span>
                        <span class="limit-tag vip">‚≠ê VIP: 13</span>
                    </div>
                </div>

                <!-- Queue Section -->
                <div class="queue-panel">
                    <div class="queue-header-bar">
                        <span>üìã UP NEXT</span>
                        <span id="queue-count">0 tracks</span>
                    </div>
                    <div id="youtube-queue" class="yt-queue-container">
                        <div class="empty-queue">Drop some tracks! üéµ</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Profile Modal - Modern Facebook Style -->
    <div id="profile-modal"
        class="modal-overlay hidden fixed inset-0 bg-black/85 backdrop-blur-md z-[9000] flex items-center justify-center p-3">
        <div class="profile-modal-container">
            <!-- Close Button -->
            <button class="profile-close-btn" onclick="game.closeModals()" title="Close">
                <i class="ph-bold ph-x"></i>
            </button>

            <!-- Header: Cover + Avatar + Name -->
            <div class="profile-header-section">
                <!-- Cover Photo -->
                <div class="profile-cover" id="profile-cover-photo">
                    <div class="profile-cover-overlay"></div>
                    <button class="profile-cover-edit" onclick="triggerCoverUpload()">
                        <i class="ph-fill ph-camera"></i>
                        <span>Edit Cover</span>
                    </button>
                </div>

                <!-- Avatar + Basic Info Row -->
                <div class="profile-identity">
                    <div class="profile-avatar-container">
                        <div class="profile-avatar" id="profile-avatar-main">
                            <img src="" alt="Profile" id="profile-avatar-img">
                            <div class="profile-avatar-fallback">üë§</div>
                        </div>
                        <button class="profile-avatar-edit" onclick="triggerAvatarUpload()" title="Change Photo">
                            <i class="ph-fill ph-camera"></i>
                        </button>
                        <div class="profile-level-badge" id="profile-level-badge">Lv.1</div>
                    </div>

                    <div class="profile-name-section">
                        <h1 class="profile-display-name" id="profile-display-name">Player Name</h1>
                        <p class="profile-username" id="profile-username">@username</p>
                        <div class="profile-role" id="profile-role">
                            <i class="ph-fill ph-crown"></i> Club Owner
                        </div>
                    </div>

                    <div class="profile-quick-actions">
                        <button class="pqa-btn pqa-primary" onclick="openEditProfile()">
                            <i class="ph-fill ph-pencil-simple"></i> Edit Profile
                        </button>
                        <button class="pqa-btn" onclick="game.openModal('settings')" title="Settings">
                            <i class="ph-fill ph-gear"></i>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Main Content Area -->
            <div class="profile-content-area">
                <!-- Left Column: Info + Stats -->
                <div class="profile-sidebar">
                    <!-- Bio Card -->
                    <div class="profile-card">
                        <h3 class="profile-card-title"><i class="ph-fill ph-user"></i> About</h3>
                        <p class="profile-bio" id="profile-bio">Welcome to my club! üéâ</p>

                        <div class="profile-details">
                            <div class="profile-detail-item">
                                <i class="ph-fill ph-buildings"></i>
                                <div>
                                    <span class="detail-label">Club</span>
                                    <span class="detail-value" id="profile-club-name">My Club</span>
                                </div>
                            </div>
                            <div class="profile-detail-item">
                                <i class="ph-fill ph-calendar-blank"></i>
                                <div>
                                    <span class="detail-label">Joined</span>
                                    <span class="detail-value" id="profile-join-date">Jan 2024</span>
                                </div>
                            </div>
                            <div class="profile-detail-item">
                                <i class="ph-fill ph-clock"></i>
                                <div>
                                    <span class="detail-label">Last Active</span>
                                    <span class="detail-value" id="profile-last-active">Just now</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Stats Card -->
                    <div class="profile-card">
                        <h3 class="profile-card-title"><i class="ph-fill ph-chart-bar"></i> Statistics</h3>
                        <div class="profile-stats-grid">
                            <div class="profile-stat">
                                <span class="stat-value" id="stat-posts">0</span>
                                <span class="stat-label">Posts</span>
                            </div>
                            <div class="profile-stat">
                                <span class="stat-value" id="stat-reactions">0</span>
                                <span class="stat-label">Reactions</span>
                            </div>
                            <div class="profile-stat">
                                <span class="stat-value" id="stat-visitors">0</span>
                                <span class="stat-label">Visitors</span>
                            </div>
                            <div class="profile-stat">
                                <span class="stat-value" id="stat-earnings">$0</span>
                                <span class="stat-label">Earnings</span>
                            </div>
                        </div>

                        <div class="profile-highlights">
                            <div class="highlight-item">
                                <span class="highlight-icon">üî•</span>
                                <span class="highlight-value" id="stat-hype">0</span>
                                <span class="highlight-label">Hype Score</span>
                            </div>
                            <div class="highlight-item">
                                <span class="highlight-icon">üèÜ</span>
                                <span class="highlight-value" id="stat-achievements">0</span>
                                <span class="highlight-label">Achievements</span>
                            </div>
                        </div>
                    </div>

                    <!-- Quick Links -->
                    <div class="profile-card profile-links">
                        <button class="profile-link-btn" onclick="game.openModal('achievements')">
                            <i class="ph-fill ph-trophy"></i> View Achievements
                        </button>
                        <button class="profile-link-btn" onclick="game.openModal('friends')">
                            <i class="ph-fill ph-users"></i> Friends List
                        </button>
                        <button class="profile-link-btn logout" onclick="handleLogout()">
                            <i class="ph-fill ph-sign-out"></i> Logout
                        </button>
                    </div>
                </div>

                <!-- Right Column: Posts -->
                <div class="profile-main">
                    <!-- Create Post -->
                    <div class="profile-card create-post-card">
                        <div class="create-post-top">
                            <div class="create-post-avatar" id="create-post-avatar">üë§</div>
                            <textarea id="post-text-input" placeholder="What's happening at your club?"
                                rows="2"></textarea>
                        </div>

                        <div id="post-image-preview" class="post-image-preview">
                            <img id="post-preview-img" src="" alt="Preview">
                            <button class="remove-preview" onclick="removePostImage()" title="Remove Image">
                                <i class="ph-bold ph-x"></i>
                            </button>
                        </div>

                        <div class="create-post-bottom">
                            <div class="post-add-options">
                                <button class="post-add-btn" onclick="triggerPostImageUpload()" title="Add Photo">
                                    <i class="ph-fill ph-image"></i>
                                </button>
                                <button class="post-add-btn" onclick="addEmoji()" title="Add Emoji">
                                    <i class="ph-fill ph-smiley"></i>
                                </button>
                            </div>
                            <button class="post-submit-btn" onclick="submitPost()" id="post-submit-btn">
                                Post <i class="ph-fill ph-paper-plane-tilt"></i>
                            </button>
                        </div>
                    </div>

                    <!-- Posts Feed -->
                    <div class="posts-feed-section">
                        <div class="feed-header">
                            <h3><i class="ph-fill ph-newspaper"></i> Activity Feed</h3>
                        </div>
                        <div id="posts-feed-container" class="posts-container">
                            <div class="no-posts-message">
                                <i class="ph-light ph-note-blank"></i>
                                <p>No posts yet</p>
                                <span>Share your first club update!</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Hidden File Inputs -->
        <input type="file" id="cover-upload-input" accept="image/*" style="display:none;"
            onchange="handleCoverUpload(event)">
        <input type="file" id="avatar-upload-input" accept="image/*" style="display:none;"
            onchange="handleAvatarUpload(event)">
        <input type="file" id="post-image-input" accept="image/*" style="display:none;"
            onchange="handlePostImageSelect(event)">
    </div>

    <!-- Club Upgrade Modal -->
    <div id="club-upgrade-modal" class="modal-overlay hidden">
        <div class="modal-content modal-small">
            <div class="modal-header">
                <h2 class="modal-title">üèóÔ∏è Upgrade Club</h2>
                <button class="modal-close" onclick="game.closeModals()">‚úï</button>
            </div>
            <div class="club-upgrade-content">
                <div class="current-tier">
                    <h4>Current Size</h4>
                    <div class="tier-name" id="upgrade-current-tier">Tiny Bar</div>
                    <div class="tier-stats">Capacity: <span id="upgrade-current-capacity">8</span> visitors</div>
                </div>

                <div class="upgrade-arrow">‚¨áÔ∏è</div>

                <div class="next-tier" id="next-tier-section">
                    <h4>Next Upgrade</h4>
                    <div class="tier-name" id="upgrade-next-tier">Small Club</div>
                    <div class="tier-stats">Capacity: <span id="upgrade-next-capacity">15</span> visitors</div>
                    <div class="tier-unlock">Requires Level <span id="upgrade-required-level">3</span></div>
                    <div class="tier-cost">Cost: $<span id="upgrade-cost">2,000</span></div>
                </div>

                <div id="max-tier-message" class="max-tier-message" style="display: none;">
                    üéâ Your club is at maximum size!
                </div>

                <button class="upgrade-btn" id="do-upgrade-btn" onclick="doClubUpgrade()">
                    üèóÔ∏è Upgrade Now
                </button>
            </div>
        </div>
    </div>

    <!-- Login Modal -->
    <div id="login-modal" class="modal-overlay hidden">
        <div class="modal-content modal-small">
            <div class="modal-header">
                <h2 class="modal-title">üë§ Login / Register</h2>
                <button class="modal-close" onclick="game.closeModals()">‚úï</button>
            </div>
            <div class="login-content">
                <div class="login-tabs">
                    <button class="login-tab active" onclick="switchLoginTab('login')">Login</button>
                    <button class="login-tab" onclick="switchLoginTab('register')">Register</button>
                </div>

                <div id="login-form" class="login-form">
                    <input type="email" id="login-email" placeholder="Email" class="auth-input">
                    <input type="password" id="login-password" placeholder="Password" class="auth-input">
                    <button class="auth-btn primary" onclick="handleLogin()">Login</button>
                    <button class="auth-btn forgot" onclick="handleForgotPassword()">Forgot Password?</button>
                </div>

                <div id="register-form" class="login-form" style="display: none;">
                    <input type="text" id="register-name" placeholder="Display Name" class="auth-input">
                    <input type="email" id="register-email" placeholder="Email" class="auth-input">
                    <input type="password" id="register-password" placeholder="Password (min 6 chars)"
                        class="auth-input">
                    <button class="auth-btn primary" onclick="handleRegister()">Create Account</button>
                </div>

                <div class="login-divider"><span>or</span></div>

                <button class="auth-btn google" onclick="handleGoogleLogin()">
                    <img src="https://www.google.com/favicon.ico" alt="G"> Continue with Google
                </button>

                <p class="login-note">Login to save progress to cloud and access premium features!</p>
            </div>
        </div>
    </div>

    <!-- Account Modal -->
    <div id="account-modal" class="modal-overlay hidden">
        <div class="modal-content modal-small">
            <div class="modal-header">
                <h2 class="modal-title">üë§ My Account</h2>
                <button class="modal-close" onclick="game.closeModals()">‚úï</button>
            </div>
            <div class="account-content">
                <div class="account-profile">
                    <img class="account-avatar" id="account-avatar" src="" alt="">
                    <div class="account-info">
                        <span class="account-name" id="account-name">Player</span>
                        <span class="account-email" id="account-email">email@example.com</span>
                        <span class="account-vip" id="vip-status">Not VIP</span>
                    </div>
                </div>
                <div class="account-stats">
                    <div class="account-stat">
                        <span class="stat-value" id="account-coins">0</span>
                        <span class="stat-label">üíé Coins</span>
                    </div>
                    <div class="account-stat">
                        <span class="stat-value" id="account-level">1</span>
                        <span class="stat-label">‚≠ê Level</span>
                    </div>
                </div>
                <div class="account-actions">
                    <button class="account-btn" onclick="game.openModal('shop')">üõí Shop</button>
                    <button class="account-btn" onclick="cloudSaveNow()">‚òÅÔ∏è Save to Cloud</button>
                    <button class="account-btn danger" onclick="handleLogout()">üö™ Logout</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Premium Shop Modal -->
    <div id="premium-shop-modal" class="modal-overlay hidden">
        <div class="modal-content modal-large">
            <div class="modal-header">
                <h2 class="modal-title">üíé Premium Shop</h2>
                <button class="modal-close" onclick="game.closeModals()">‚úï</button>
            </div>
            <div class="shop-content">
                <div class="shop-tabs">
                    <button class="shop-tab active" onclick="switchShopTab('vip')">üëë VIP</button>
                    <button class="shop-tab" onclick="switchShopTab('coins')">üíé Coins</button>
                    <button class="shop-tab" onclick="switchShopTab('items')">üéÅ Items</button>
                </div>

                <!-- VIP Tab -->
                <div id="shop-vip" class="shop-section">
                    <div class="vip-promo">
                        <h3>üëë Become a VIP!</h3>
                        <ul class="vip-perks">
                            <li>‚ú® 2x XP on all activities</li>
                            <li>üé® Exclusive VIP furniture</li>
                            <li>üè∑Ô∏è VIP badge on profile</li>
                            <li>üíé Bonus coins included</li>
                            <li>üéÅ Early access to new features</li>
                        </ul>
                    </div>
                    <div class="shop-items">
                        <div class="shop-item vip-item" onclick="purchaseVIP('vip_monthly')">
                            <span class="item-name">VIP Monthly</span>
                            <span class="item-bonus">+500 Coins</span>
                            <span class="item-price">$4.99</span>
                        </div>
                        <div class="shop-item vip-item best-value" onclick="purchaseVIP('vip_yearly')">
                            <span class="best-badge">BEST VALUE</span>
                            <span class="item-name">VIP Yearly</span>
                            <span class="item-bonus">+7,000 Coins</span>
                            <span class="item-price">$39.99</span>
                            <span class="item-save">Save 33%!</span>
                        </div>
                    </div>
                </div>

                <!-- Coins Tab -->
                <div id="shop-coins" class="shop-section" style="display: none;">
                    <div class="shop-items coins-grid">
                        <div class="shop-item coin-item" onclick="purchaseCoins('coins_100')">
                            <span class="coin-amount">üíé 100</span>
                            <span class="item-price">$0.99</span>
                        </div>
                        <div class="shop-item coin-item" onclick="purchaseCoins('coins_500')">
                            <span class="coin-amount">üíé 550</span>
                            <span class="coin-bonus">+50 bonus</span>
                            <span class="item-price">$4.99</span>
                        </div>
                        <div class="shop-item coin-item popular" onclick="purchaseCoins('coins_1200')">
                            <span class="popular-badge">POPULAR</span>
                            <span class="coin-amount">üíé 1,300</span>
                            <span class="coin-bonus">+100 bonus</span>
                            <span class="item-price">$9.99</span>
                        </div>
                        <div class="shop-item coin-item" onclick="purchaseCoins('coins_2500')">
                            <span class="coin-amount">üíé 2,800</span>
                            <span class="coin-bonus">+300 bonus</span>
                            <span class="item-price">$19.99</span>
                        </div>
                        <div class="shop-item coin-item best-value" onclick="purchaseCoins('coins_6500')">
                            <span class="best-badge">BEST VALUE</span>
                            <span class="coin-amount">üíé 7,500</span>
                            <span class="coin-bonus">+1,000 bonus</span>
                            <span class="item-price">$49.99</span>
                        </div>
                    </div>
                </div>

                <!-- Items Tab -->
                <div id="shop-items" class="shop-section" style="display: none;">
                    <div class="shop-category">
                        <h4>‚ö° Boosters</h4>
                        <div class="item-grid">
                            <div class="coin-purchase-item" onclick="purchaseItem('xp_boost_1h')">
                                <span class="item-icon">‚ö°</span>
                                <span class="item-name">2x XP (1hr)</span>
                                <span class="item-cost">üíé 50</span>
                            </div>
                            <div class="coin-purchase-item" onclick="purchaseItem('cash_boost_1h')">
                                <span class="item-icon">üíµ</span>
                                <span class="item-name">2x Cash (1hr)</span>
                                <span class="item-cost">üíé 50</span>
                            </div>
                            <div class="coin-purchase-item" onclick="purchaseItem('hype_boost')">
                                <span class="item-icon">üî•</span>
                                <span class="item-name">+50 Hype</span>
                                <span class="item-cost">üíé 30</span>
                            </div>
                        </div>
                    </div>
                    <div class="shop-category">
                        <h4>ü™ë Exclusive Furniture</h4>
                        <div class="item-grid">
                            <div class="coin-purchase-item" onclick="purchaseItem('vip_booth')">
                                <span class="item-icon">üõãÔ∏è</span>
                                <span class="item-name">VIP Booth</span>
                                <span class="item-cost">üíé 200</span>
                            </div>
                            <div class="coin-purchase-item" onclick="purchaseItem('gold_dancefloor')">
                                <span class="item-icon">‚ú®</span>
                                <span class="item-name">Gold Dance Floor</span>
                                <span class="item-cost">üíé 500</span>
                            </div>
                            <div class="coin-purchase-item vip-only" onclick="purchaseItem('crystal_bar')">
                                <span class="vip-required">üëë VIP</span>
                                <span class="item-icon">üíé</span>
                                <span class="item-name">Crystal Bar</span>
                                <span class="item-cost">üíé 800</span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="shop-footer">
                    <span class="your-coins">Your Coins: üíé <span id="shop-coins-display">0</span></span>
                </div>
            </div>
        </div>
    </div>

    <!-- Celebrity Booking Modal -->
    <div id="celebrity-modal"
        class="modal-overlay hidden fixed inset-0 bg-black/80 backdrop-blur-sm z-[100] flex items-center justify-center p-4">
        <div class="glass-panel rounded-3xl w-full max-w-3xl max-h-[85vh] overflow-hidden font-display">
            <!-- Header -->
            <div class="flex items-center justify-between p-5 border-b border-white/10">
                <h2 class="text-2xl font-bold text-white flex items-center gap-3">
                    <i class="ph-fill ph-star text-yellow-400"></i>
                    Celebrity Booking
                </h2>
                <div class="flex items-center gap-4">
                    <div class="flex items-center gap-2 bg-purple-500/20 px-3 py-1 rounded-full">
                        <i class="ph-fill ph-diamond text-purple-400"></i>
                        <span class="font-bold text-purple-400" id="diamond-count">0</span>
                    </div>
                    <button
                        class="w-10 h-10 rounded-xl bg-white/10 hover:bg-red-500/50 flex items-center justify-center text-white transition-colors"
                        onclick="game.closeCelebrityModal()">
                        <i class="ph-bold ph-x text-xl"></i>
                    </button>
                </div>
            </div>

            <!-- Content -->
            <div class="p-5 overflow-y-auto max-h-[70vh]" id="celebrity-booking-content">
                <!-- Populated by JS -->
            </div>
        </div>
    </div>

    <!-- Notification System -->
    <script src="js/notifications.js"></script>

    <!-- Main Script -->
    <!-- Protection System - MUST LOAD FIRST -->
    <script src="js/protection.js"></script>

    <!-- Version Management -->
    <script src="js/version.js"></script>

    <script type="module" src="js/main.js?v=2"></script>

    <!-- Anti-Cheat System -->
    <script type="module" src="js/anticheat.js"></script>

    <!-- Background music controls (must be after module loads) -->
    <script>
        function playBgTrack(index) {
            if (window.djSystem && window.djSystem.playBgTrack) {
                window.djSystem.playBgTrack(index);
            } else {
                console.log('DJ System loading...');
                setTimeout(() => playBgTrack(index), 500);
            }
        }
        function stopBgMusic() {
            if (window.djSystem && window.djSystem.stopBackgroundMusic) {
                window.djSystem.stopBackgroundMusic();
            }
        }
        function setBgVolume(vol) {
            if (window.djSystem && window.djSystem.setBgMusicVolume) {
                window.djSystem.setBgMusicVolume(vol);
            }
        }

        // Friends panel - standalone version
        // Use the friends system's toggle function
        function toggleFriends() {
            console.log('toggleFriends called');
            if (window.friendsSystem && window.friendsSystem.togglePanel) {
                window.friendsSystem.togglePanel();
            } else {
                console.warn('Friends system not available');
            }
        }

        function switchFriendsTab(tab) {
            if (window.friendsSystem && window.friendsSystem.switchTab) {
                window.friendsSystem.switchTab(tab);
            }
        }

        // Sync graphics quality dropdown with saved settings
        document.addEventListener('DOMContentLoaded', () => {
            const savedQuality = localStorage.getItem('graphics_quality') || 'high';
            const dropdown = document.getElementById('graphics-quality');
            if (dropdown) {
                dropdown.value = savedQuality;
            }
        });

        // Navigate to Social World
        function goToWorld() {
            // Save game before leaving
            if (window.game && window.game.manualSave) {
                window.game.manualSave();
            }
            window.location.href = 'world.html';
        }

        // ================== LANDING PAGE FUNCTIONS ==================

        // Open/Close Login Modal
        window.openLoginModal = function () {
            document.getElementById('login-modal').classList.remove('hidden');
        };

        window.closeLoginModal = function () {
            document.getElementById('login-modal').classList.add('hidden');
        };

        // Smooth scroll within landing page
        window.smoothScroll = function (targetId) {
            event.preventDefault();
            const landingPage = document.getElementById('login-gate');
            const target = document.getElementById(targetId);
            if (target && landingPage) {
                const targetPosition = target.offsetTop - 80;
                landingPage.scrollTo({ top: targetPosition, behavior: 'smooth' });
            }
        };

        // Toggle mobile menu
        window.toggleMobileMenu = function () {
            const mobileNav = document.getElementById('mobile-nav');
            if (mobileNav) {
                mobileNav.classList.toggle('hidden');
            }
        };

        // Load landing page leaderboards with fallback
        function loadLandingLeaderboards() {
            const playersContainer = document.getElementById('landing-top-players');
            const clubsContainer = document.getElementById('landing-top-clubs');

            // Sample fallback data
            const samplePlayers = [
                { name: 'Player', club: 'My Club', avatar: 'üòé', level: 1 },
                { name: 'DJMaster', club: 'Neon Nights', avatar: 'üéß', level: 12 },
                { name: 'PartyKing', club: 'Club Royal', avatar: 'üëë', level: 8 }
            ];
            const sampleClubs = [
                { name: 'Yahwah', owner: 'Yahwah', hype: 0 },
                { name: 'Neon Paradise', owner: 'DJMaster', hype: 1500 },
                { name: 'The Vault', owner: 'PartyKing', hype: 980 }
            ];

            function renderPlayers(players) {
                if (!playersContainer) return;
                const medals = ['ü•á', 'ü•à', 'ü•â'];
                playersContainer.innerHTML = players.map((p, i) => `
                    <div class="lb-item" style="display:flex;align-items:center;gap:12px;padding:12px 16px;background:rgba(255,255,255,0.02);border-radius:10px;">
                        <span style="font-size:20px;">${medals[i]}</span>
                        <div style="width:36px;height:36px;background:linear-gradient(135deg,#ff0066,#a855f7);border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:16px;">${p.avatar}</div>
                        <div style="flex:1;">
                            <div style="font-size:13px;font-weight:700;color:white;">${p.name}</div>
                            <div style="font-size:11px;color:rgba(255,255,255,0.4);">${p.club}</div>
                        </div>
                        <div style="background:rgba(168,85,247,0.2);padding:4px 10px;border-radius:20px;font-size:11px;color:#c084fc;font-weight:700;">Lv ${p.level}</div>
                    </div>
                `).join('');
            }

            function renderClubs(clubs) {
                if (!clubsContainer) return;
                const medals = ['ü•á', 'ü•à', 'ü•â'];
                clubsContainer.innerHTML = clubs.map((c, i) => `
                    <div class="lb-item" style="display:flex;align-items:center;gap:12px;padding:12px 16px;background:rgba(255,255,255,0.02);border-radius:10px;">
                        <span style="font-size:20px;">${medals[i]}</span>
                        <div style="width:36px;height:36px;background:rgba(255,0,102,0.2);border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:16px;">üè¢</div>
                        <div style="flex:1;">
                            <div style="font-size:13px;font-weight:700;color:white;">${c.name}</div>
                            <div style="font-size:11px;color:rgba(255,255,255,0.4);">by ${c.owner}</div>
                        </div>
                        <div style="display:flex;align-items:center;gap:4px;color:#ff6b9d;font-size:12px;font-weight:700;">‚ù§Ô∏è ${c.hype}</div>
                    </div>
                `).join('');
            }

            // Try Firebase first (only if initialized)
            if (typeof firebase !== 'undefined' && firebase.apps && firebase.apps.length > 0) {
                const db = firebase.firestore();

                // Get players
                db.collection('users').orderBy('level', 'desc').limit(3).get()
                    .then(snap => {
                        if (!snap.empty) {
                            const players = [];
                            snap.forEach(doc => {
                                const d = doc.data();
                                players.push({ name: d.displayName || 'Player', club: d.clubName || 'My Club', avatar: d.avatar || 'üòé', level: d.level || 1 });
                            });
                            renderPlayers(players);
                        } else {
                            renderPlayers(samplePlayers);
                        }
                    })
                    .catch(() => renderPlayers(samplePlayers));

                // Get clubs
                db.collection('users').orderBy('hype', 'desc').limit(3).get()
                    .then(snap => {
                        if (!snap.empty) {
                            const clubs = [];
                            snap.forEach(doc => {
                                const d = doc.data();
                                clubs.push({ name: d.clubName || 'Club', owner: d.displayName || 'Owner', hype: d.hype || 0 });
                            });
                            renderClubs(clubs);
                        } else {
                            renderClubs(sampleClubs);
                        }
                    })
                    .catch(() => renderClubs(sampleClubs));
            } else {
                // No Firebase, use sample data
                renderPlayers(samplePlayers);
                renderClubs(sampleClubs);
            }
        }

        // Load leaderboards when page loads (wait for Firebase to initialize)
        setTimeout(loadLandingLeaderboards, 3000);

        // Switch between login and register tabs
        window.switchGateTab = function (tab) {
            const loginForm = document.getElementById('gate-login-form');
            const registerForm = document.getElementById('gate-register-form');
            const tabs = document.querySelectorAll('.modal-tab');

            tabs.forEach(t => t.classList.remove('active'));
            if (event && event.target) event.target.classList.add('active');

            if (tab === 'login') {
                loginForm.classList.remove('hidden');
                registerForm.classList.add('hidden');
            } else {
                loginForm.classList.add('hidden');
                registerForm.classList.remove('hidden');
            }
        };

        // Initialize 3D Hero Scene - Optimized DJ Club
        function initHero3D() {
            const canvas = document.getElementById('hero-3d-canvas');
            if (!canvas || typeof THREE === 'undefined') return;

            const scene = new THREE.Scene();
            const camera = new THREE.PerspectiveCamera(60, window.innerWidth / window.innerHeight, 0.1, 1000);
            const renderer = new THREE.WebGLRenderer({ canvas, alpha: true, antialias: false });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setPixelRatio(1);

            // Harmonized Colors
            const COLORS = { pink: 0xff0066, purple: 0xa855f7, cyan: 0x00d4ff };

            // Lights (optimized - only 2)
            const mainLight = new THREE.PointLight(COLORS.pink, 3, 50);
            mainLight.position.set(0, 10, 5);
            scene.add(mainLight);
            const accentLight = new THREE.PointLight(COLORS.cyan, 2, 40);
            accentLight.position.set(-10, 5, 10);
            scene.add(accentLight);
            scene.add(new THREE.AmbientLight(0x222244, 0.5));

            // Dance Floor with tiles
            const tiles = [];
            for (let x = -4; x <= 4; x++) {
                for (let z = -3; z <= 2; z++) {
                    const tile = new THREE.Mesh(
                        new THREE.PlaneGeometry(1.8, 1.8),
                        new THREE.MeshBasicMaterial({ color: [COLORS.pink, COLORS.cyan, COLORS.purple][(x + z + 10) % 3], transparent: true, opacity: 0.3 })
                    );
                    tile.rotation.x = -Math.PI / 2;
                    tile.position.set(x * 2, 0, z * 2);
                    tiles.push(tile);
                    scene.add(tile);
                }
            }

            // Stage
            const stage = new THREE.Mesh(
                new THREE.BoxGeometry(8, 1.5, 4),
                new THREE.MeshBasicMaterial({ color: 0x1a1a2e })
            );
            stage.position.set(0, 0.75, -8);
            scene.add(stage);
            const stageEdge = new THREE.Mesh(
                new THREE.BoxGeometry(8.2, 0.2, 0.2),
                new THREE.MeshBasicMaterial({ color: COLORS.pink })
            );
            stageEdge.position.set(0, 1.5, -6.1);
            scene.add(stageEdge);

            // DJ Character (4x scale)
            const scale = 2.5;
            const body = new THREE.Mesh(
                new THREE.CapsuleGeometry(0.5 * scale, 1 * scale, 4, 8),
                new THREE.MeshBasicMaterial({ color: 0x2a2a4a })
            );
            body.position.set(0, 1.2 * scale + 1.5, -8);
            scene.add(body);

            const head = new THREE.Mesh(
                new THREE.SphereGeometry(0.4 * scale, 8, 8),
                new THREE.MeshBasicMaterial({ color: 0xffdbac })
            );
            head.position.set(0, 2.5 * scale + 1.5, -8);
            scene.add(head);

            // Sunglasses
            const glasses = new THREE.Mesh(
                new THREE.BoxGeometry(0.8 * scale, 0.15 * scale, 0.1 * scale),
                new THREE.MeshBasicMaterial({ color: COLORS.cyan })
            );
            glasses.position.set(0, 2.55 * scale + 1.5, -7.6);
            scene.add(glasses);

            // Arms
            const leftArm = new THREE.Mesh(
                new THREE.CapsuleGeometry(0.12 * scale, 0.6 * scale, 4, 4),
                new THREE.MeshBasicMaterial({ color: 0xffdbac })
            );
            leftArm.position.set(-0.6 * scale, 1.8 * scale + 1.5, -7.5);
            leftArm.rotation.x = -0.5;
            scene.add(leftArm);
            const rightArm = new THREE.Mesh(
                new THREE.CapsuleGeometry(0.12 * scale, 0.6 * scale, 4, 4),
                new THREE.MeshBasicMaterial({ color: 0xffdbac })
            );
            rightArm.position.set(0.6 * scale, 1.8 * scale + 1.5, -7.5);
            rightArm.rotation.x = -0.5;
            scene.add(rightArm);

            // DJ Booth
            const booth = new THREE.Mesh(
                new THREE.BoxGeometry(4, 1, 2),
                new THREE.MeshBasicMaterial({ color: 0x1a1a2e })
            );
            booth.position.set(0, 2, -7);
            scene.add(booth);

            // Turntables
            const leftVinyl = new THREE.Mesh(
                new THREE.CylinderGeometry(0.5, 0.5, 0.05, 16),
                new THREE.MeshBasicMaterial({ color: 0x111111 })
            );
            leftVinyl.position.set(-1, 2.55, -7);
            leftVinyl.rotation.x = Math.PI / 2;
            scene.add(leftVinyl);
            const leftLabel = new THREE.Mesh(
                new THREE.CylinderGeometry(0.15, 0.15, 0.06, 8),
                new THREE.MeshBasicMaterial({ color: COLORS.pink })
            );
            leftLabel.position.set(-1, 2.56, -7);
            leftLabel.rotation.x = Math.PI / 2;
            scene.add(leftLabel);

            const rightVinyl = new THREE.Mesh(
                new THREE.CylinderGeometry(0.5, 0.5, 0.05, 16),
                new THREE.MeshBasicMaterial({ color: 0x111111 })
            );
            rightVinyl.position.set(1, 2.55, -7);
            rightVinyl.rotation.x = Math.PI / 2;
            scene.add(rightVinyl);
            const rightLabel = new THREE.Mesh(
                new THREE.CylinderGeometry(0.15, 0.15, 0.06, 8),
                new THREE.MeshBasicMaterial({ color: COLORS.cyan })
            );
            rightLabel.position.set(1, 2.56, -7);
            rightLabel.rotation.x = Math.PI / 2;
            scene.add(rightLabel);

            // Speakers
            const spkL = new THREE.Mesh(new THREE.BoxGeometry(1.5, 2.5, 1), new THREE.MeshBasicMaterial({ color: 0x1a1a2e }));
            spkL.position.set(-5, 2.75, -8);
            scene.add(spkL);
            const spkRingL = new THREE.Mesh(new THREE.RingGeometry(0.3, 0.5, 16), new THREE.MeshBasicMaterial({ color: COLORS.purple, side: THREE.DoubleSide }));
            spkRingL.position.set(-5, 2.75, -7.4);
            scene.add(spkRingL);
            const spkR = new THREE.Mesh(new THREE.BoxGeometry(1.5, 2.5, 1), new THREE.MeshBasicMaterial({ color: 0x1a1a2e }));
            spkR.position.set(5, 2.75, -8);
            scene.add(spkR);
            const spkRingR = new THREE.Mesh(new THREE.RingGeometry(0.3, 0.5, 16), new THREE.MeshBasicMaterial({ color: COLORS.purple, side: THREE.DoubleSide }));
            spkRingR.position.set(5, 2.75, -7.4);
            scene.add(spkRingR);

            // 6 Dancers
            const dancers = [];
            const dancerPositions = [[-4, 0], [-2, 2], [0, 1], [2, 2], [4, 0], [0, -2]];
            dancerPositions.forEach((pos, i) => {
                const dBody = new THREE.Mesh(new THREE.CapsuleGeometry(0.25, 0.6, 4, 4), new THREE.MeshBasicMaterial({ color: [0xff6b9d, 0x6b9dff, 0x9dff6b, 0xffff6b, 0xff6bff, 0x6bffff][i] }));
                const dHead = new THREE.Mesh(new THREE.SphereGeometry(0.2, 6, 6), new THREE.MeshBasicMaterial({ color: 0xffdbac }));
                dBody.position.set(pos[0], 1, pos[1]);
                dHead.position.set(pos[0], 1.8, pos[1]);
                const group = new THREE.Group();
                group.add(dBody);
                group.add(dHead);
                group.position.set(0, 0, 0);
                group.userData = { body: dBody, head: dHead, offset: i * 0.5 };
                dancers.push(group);
                scene.add(group);
            });

            // 3 Laser beams
            const lasers = [];
            for (let i = 0; i < 3; i++) {
                const laser = new THREE.Mesh(
                    new THREE.CylinderGeometry(0.03, 0.03, 30, 4),
                    new THREE.MeshBasicMaterial({ color: [COLORS.pink, COLORS.cyan, COLORS.purple][i], transparent: true, opacity: 0.3 })
                );
                laser.position.set(-8 + i * 8, 12, -12);
                laser.rotation.x = Math.PI / 4;
                lasers.push(laser);
                scene.add(laser);
            }

            // 8 Music notes
            const notes = [];
            for (let i = 0; i < 8; i++) {
                const note = new THREE.Mesh(
                    new THREE.SphereGeometry(0.15, 4, 4),
                    new THREE.MeshBasicMaterial({ color: [COLORS.pink, COLORS.cyan, COLORS.purple][i % 3], transparent: true, opacity: 0.5 })
                );
                note.position.set((Math.random() - 0.5) * 30, Math.random() * 10 + 5, (Math.random() - 0.5) * 20);
                note.userData = { baseY: note.position.y, offset: Math.random() * 6 };
                notes.push(note);
                scene.add(note);
            }

            // Isometric camera
            camera.position.set(25, 18, 25);
            camera.lookAt(0, 4, -5);

            // Mouse parallax
            let mouseX = 0, mouseY = 0, targetX = 0, targetY = 0;
            document.addEventListener('mousemove', (e) => {
                mouseX = (e.clientX / window.innerWidth - 0.5) * 2;
                mouseY = (e.clientY / window.innerHeight - 0.5) * 2;
            });

            // Animation
            let time = 0;
            function animate() {
                requestAnimationFrame(animate);
                time += 0.016;

                targetX += (mouseX - targetX) * 0.05;
                targetY += (mouseY - targetY) * 0.05;
                camera.position.x = 25 + targetX * 5;
                camera.position.y = 18 - targetY * 2;
                camera.lookAt(0, 4, -5);

                // DJ bounce
                body.position.y = 1.2 * scale + 1.5 + Math.sin(time * 5) * 0.12;
                head.position.y = 2.5 * scale + 1.5 + Math.sin(time * 5) * 0.08;
                head.rotation.y = Math.sin(time * 2) * 0.15;
                leftArm.rotation.x = -0.5 + Math.sin(time * 3) * 0.2;
                rightArm.rotation.x = -0.5 + Math.sin(time * 3 + 1) * 0.2;

                // Vinyls spin
                leftVinyl.rotation.z += 0.03;
                rightVinyl.rotation.z += 0.025;
                leftLabel.rotation.z += 0.03;
                rightLabel.rotation.z += 0.025;

                // Speaker pulse
                const pulse = 1 + Math.sin(time * 6) * 0.1;
                spkRingL.scale.set(pulse, pulse, 1);
                spkRingR.scale.set(pulse, pulse, 1);

                // Dancers
                dancers.forEach((d) => {
                    const t = time + d.userData.offset;
                    d.userData.body.position.y = 1 + Math.abs(Math.sin(t * 4)) * 0.25;
                    d.userData.head.position.y = 1.8 + Math.abs(Math.sin(t * 4)) * 0.2;
                    d.rotation.y = Math.sin(t * 1.5) * 0.2;
                });

                // Tiles pulse
                tiles.forEach((tile, i) => {
                    tile.material.opacity = 0.2 + Math.sin(time * 3 + i) * 0.15;
                });

                // Lasers sway
                lasers.forEach((laser, i) => {
                    laser.rotation.z = Math.sin(time * 1.5 + i) * 0.4;
                });

                // Lights pulse
                mainLight.intensity = 3 + Math.sin(time * 3) * 1;
                accentLight.intensity = 2 + Math.sin(time * 3 + 1) * 0.5;

                // Notes float
                notes.forEach((note) => {
                    note.position.y = note.userData.baseY + Math.sin(time + note.userData.offset) * 2;
                });

                renderer.render(scene, camera);
            }
            animate();

            window.addEventListener('resize', () => {
                camera.aspect = window.innerWidth / window.innerHeight;
                camera.updateProjectionMatrix();
                renderer.setSize(window.innerWidth, window.innerHeight);
            });
        }

        // ================== VISIT MODE FUNCTIONS ==================

        // Store original club state for restoration
        let originalClubState = null;
        let isVisitingClub = false;

        // Show visit mode with friend's club preview
        window.showVisitMode = function (clubData, rewards) {
            isVisitingClub = true;

            // Store current state if we have game
            if (window.game) {
                originalClubState = {
                    furniture: [...(window.game.furniture || [])],
                    clubName: window.game.clubName
                };
            }

            // Update banner
            const banner = document.getElementById('visit-banner');
            const clubNameEl = document.getElementById('visit-club-name');
            const cashRewardEl = document.getElementById('visit-cash-reward');
            const xpRewardEl = document.getElementById('visit-xp-reward');
            const hypeRewardEl = document.getElementById('visit-hype-reward');

            if (clubNameEl) clubNameEl.textContent = clubData.name || "Friend's Club";
            if (cashRewardEl) cashRewardEl.textContent = `+$${rewards.cash || 60}`;
            if (xpRewardEl) xpRewardEl.textContent = `+${rewards.xp || 15} XP`;
            if (hypeRewardEl) hypeRewardEl.textContent = `+${rewards.hype || 1}üî•`;

            // Show banner with animation
            if (banner) {
                banner.classList.remove('hidden');
                banner.style.animation = 'slideInDown 0.3s ease-out';
            }

            // Hide regular UI elements that shouldn't be visible when visiting
            document.body.classList.add('visit-mode');

            // Add visit mode CSS if not already added
            if (!document.getElementById('visit-mode-styles')) {
                const style = document.createElement('style');
                style.id = 'visit-mode-styles';
                style.textContent = `
                    body.visit-mode #ui-layer > div.flex.justify-between > div:first-child,
                    body.visit-mode #ui-layer > div.flex.justify-between > div:last-child,
                    body.visit-mode #ui-layer .fixed,
                    body.visit-mode .fixed.left-3,
                    body.visit-mode .fixed.right-3,
                    body.visit-mode .fixed.bottom-2,
                    body.visit-mode #now-playing-widget,
                    body.visit-mode #profile-btn,
                    body.visit-mode #btn-event,
                    body.visit-mode #vip-badge,
                    body.visit-mode #notification-bell,
                    body.visit-mode #furniture-edit-bar,
                    body.visit-mode #edit-controls,
                    body.visit-mode #chat-dock-btn,
                    body.visit-mode #restock-btn,
                    body.visit-mode #btn-mode,
                    body.visit-mode #stock-box,
                    body.visit-mode .glass-panel.rounded-2xl.p-2 {
                        display: none !important;
                        visibility: hidden !important;
                    }
                `;
                document.head.appendChild(style);
            }

            // Hide UI elements with JavaScript for reliability
            const hideVisitUI = () => {
                // Hide the entire #ui-layer
                const uiLayer = document.getElementById('ui-layer');
                if (uiLayer) {
                    uiLayer.style.display = 'none';
                }

                // Hide left sidebar (EDIT, STOCK) - fixed left-3
                document.querySelectorAll('[class*="fixed"][class*="left-3"]').forEach(el => {
                    el.style.setProperty('display', 'none', 'important');
                });

                // Hide right sidebar (star, friends, settings) - fixed right-3
                document.querySelectorAll('[class*="fixed"][class*="right-3"]').forEach(el => {
                    el.style.setProperty('display', 'none', 'important');
                });

                // Hide bottom bar - fixed bottom-2
                document.querySelectorAll('[class*="fixed"][class*="bottom-2"]').forEach(el => {
                    el.style.setProperty('display', 'none', 'important');
                });

                // Hide ALL elements with class 'fixed' except visit-banner
                document.querySelectorAll('.fixed').forEach(el => {
                    if (el.id !== 'visit-banner' && !el.closest('#visit-banner')) {
                        el.style.setProperty('display', 'none', 'important');
                    }
                });

                // Hide specific elements by ID
                const idsToHide = [
                    'now-playing-widget', 'profile-btn', 'btn-event', 'vip-badge', 'notification-bell',
                    'furniture-edit-bar', 'edit-controls', 'chat-dock-btn', 'restock-btn', 'btn-mode',
                    'stock-box', 'friends-dock-btn', 'world-dock-btn', 'level-display', 'cash-display',
                    'coins-display', 'hype-display', 'xp-bar', 'xp-text', 'notification-panel'
                ];
                idsToHide.forEach(id => {
                    const el = document.getElementById(id);
                    if (el) {
                        el.style.setProperty('display', 'none', 'important');
                        // Hide parent glass-panel containers too
                        let parent = el.closest('.glass-panel');
                        if (parent) parent.style.setProperty('display', 'none', 'important');
                        parent = el.closest('.fixed');
                        if (parent && parent.id !== 'visit-banner') {
                            parent.style.setProperty('display', 'none', 'important');
                        }
                    }
                });

                // Hide all glass-panel elements
                document.querySelectorAll('.glass-panel').forEach(el => {
                    if (!el.closest('#visit-banner') && !el.closest('.modal-overlay')) {
                        el.style.setProperty('display', 'none', 'important');
                    }
                });
            };

            // Run multiple times to catch dynamically loaded elements
            hideVisitUI();
            setTimeout(hideVisitUI, 100);
            setTimeout(hideVisitUI, 300);
            setTimeout(hideVisitUI, 500);
            setTimeout(hideVisitUI, 1000);
            setTimeout(hideVisitUI, 2000);

            // Load friend's club furniture if available
            if (clubData.furniture && window.loadClubPreview) {
                window.loadClubPreview(clubData.furniture);
            }

            console.log('Visit mode activated:', clubData.name);
        };

        // Return to own club
        window.returnToMyClub = function () {
            isVisitingClub = false;

            // Hide banner with animation
            const banner = document.getElementById('visit-banner');
            if (banner) {
                banner.style.animation = 'fadeOut 0.3s ease-out';
                setTimeout(() => {
                    banner.classList.add('hidden');
                    banner.style.animation = '';
                }, 300);
            }

            // Remove visit mode class to restore UI
            document.body.classList.remove('visit-mode');

            // Restore all hidden elements
            const uiLayer = document.getElementById('ui-layer');
            if (uiLayer) {
                uiLayer.style.display = '';
                uiLayer.style.top = '0';
            }

            // Restore all fixed elements
            document.querySelectorAll('.fixed').forEach(el => {
                el.style.display = '';
            });

            // Restore all glass-panel elements
            document.querySelectorAll('.glass-panel').forEach(el => {
                el.style.display = '';
            });

            // Restore specific elements by ID
            const idsToRestore = [
                'now-playing-widget', 'profile-btn', 'btn-event', 'vip-badge', 'notification-bell',
                'furniture-edit-bar', 'edit-controls', 'chat-dock-btn', 'restock-btn', 'btn-mode',
                'stock-box', 'friends-dock-btn', 'world-dock-btn', 'level-display', 'cash-display',
                'coins-display', 'hype-display', 'xp-bar', 'xp-text'
            ];
            idsToRestore.forEach(id => {
                const el = document.getElementById(id);
                if (el) el.style.display = '';
            });

            // Restore original club if we have stored state
            if (originalClubState && window.restoreClub) {
                window.restoreClub(originalClubState);
            }

            // Close any open visit modals
            if (window.game && window.game.closeModals) {
                window.game.closeModals();
            }

            console.log('Returned to own club');

            // Notify user
            if (window.ui && window.ui.notify) {
                window.ui.notify('Welcome back to your club!', 'success');
            }
        };

        // Check if currently visiting
        window.isVisitingFriend = function () {
            return isVisitingClub;
        };

        // ================== REPORT/FEEDBACK SYSTEM ==================

        window.openReportModal = function () {
            document.getElementById('report-modal').classList.remove('hidden');
            // Clear form
            document.getElementById('report-type').value = 'bug';
            document.getElementById('report-subject').value = '';
            document.getElementById('report-description').value = '';
        };

        window.closeReportModal = function () {
            document.getElementById('report-modal').classList.add('hidden');
        };

        window.submitReport = async function () {
            const type = document.getElementById('report-type').value;
            const subject = document.getElementById('report-subject').value.trim();
            const description = document.getElementById('report-description').value.trim();

            if (!subject) {
                ui.notify('Please enter a subject', 'error');
                return;
            }

            if (!description) {
                ui.notify('Please enter a description', 'error');
                return;
            }

            const user = window.authSystem?.user;
            if (!user) {
                ui.notify('You must be logged in to submit a report', 'error');
                return;
            }

            try {
                // Save to Firebase
                const reportData = {
                    type: type,
                    subject: subject,
                    description: description,
                    userId: user.uid,
                    userName: user.displayName || user.email || 'Unknown',
                    userEmail: user.email || null,
                    clubName: window.game?.clubName || 'Unknown',
                    gameVersion: 'v1.1.6',
                    platform: navigator.platform || 'Unknown',
                    userAgent: navigator.userAgent,
                    timestamp: firebase.database.ServerValue.TIMESTAMP,
                    status: 'pending', // pending, reviewed, resolved
                    adminNotes: null
                };

                await firebase.database().ref('gameReports').push(reportData);

                ui.notify('Report submitted successfully! Thank you for your feedback.', 'success');
                closeReportModal();
            } catch (e) {
                console.error('Failed to submit report:', e);
                ui.notify('Failed to submit report. Please try again.', 'error');
            }
        };

        // ================== FACEBOOK-STYLE PROFILE SYSTEM ==================

        // Profile data store
        let profileData = {
            posts: [],
            coverUrl: null,
            avatarUrl: null,
            bio: 'Welcome to my club! üéâ',
            totalReactions: 0
        };

        // Selected post image for upload
        let selectedPostImage = null;

        // Reactions configuration
        const REACTIONS = {
            like: { emoji: 'üëç', label: 'Like' },
            love: { emoji: '‚ù§Ô∏è', label: 'Love' },
            haha: { emoji: 'üòÇ', label: 'Haha' },
            wow: { emoji: 'üòÆ', label: 'Wow' },
            sad: { emoji: 'üò¢', label: 'Sad' },
            angry: { emoji: 'üò°', label: 'Angry' }
        };

        // Initialize profile when modal opens
        window.initFBProfile = async function () {
            const user = window.authSystem?.user;
            if (!user) return;

            // Load profile data from Firebase
            try {
                const db = firebase.database();
                const profileRef = db.ref(`profiles/${user.uid}`);
                const snapshot = await profileRef.once('value');
                const data = snapshot.val() || {};

                profileData = {
                    posts: data.posts ? Object.values(data.posts) : [],
                    coverUrl: data.coverUrl || null,
                    avatarUrl: data.avatarUrl || user.photoURL || null,
                    bio: data.bio || 'Welcome to my club! üéâ',
                    totalReactions: data.totalReactions || 0
                };

                updateProfileUI();
                loadPosts();
            } catch (e) {
                console.error('Failed to load profile:', e);
            }
        };

        // Update profile UI with current data
        function updateProfileUI() {
            const user = window.authSystem?.user;
            if (!user) return;

            // Display name
            const displayName = user.displayName || user.email?.split('@')[0] || 'Player';
            const displayNameEl = document.getElementById('profile-display-name');
            if (displayNameEl) displayNameEl.textContent = displayName;

            // Username
            const username = '@' + (user.email?.split('@')[0] || 'player');
            const usernameEl = document.getElementById('profile-username');
            if (usernameEl) usernameEl.textContent = username;

            // Bio
            const bioEl = document.getElementById('profile-bio');
            if (bioEl) bioEl.textContent = profileData.bio;

            // Cover photo
            if (profileData.coverUrl) {
                const coverEl = document.getElementById('profile-cover-photo');
                if (coverEl) coverEl.style.backgroundImage = `url(${profileData.coverUrl})`;
            }

            // Avatar
            const avatarImg = document.getElementById('profile-avatar-img');
            const avatarFallback = document.querySelector('.profile-avatar-fallback');
            if (avatarImg && profileData.avatarUrl) {
                avatarImg.src = profileData.avatarUrl;
                avatarImg.style.display = 'block';
                if (avatarFallback) avatarFallback.style.display = 'none';
            } else if (avatarImg) {
                avatarImg.style.display = 'none';
                if (avatarFallback) avatarFallback.style.display = 'flex';
            }

            // Post avatar
            const postAvatar = document.getElementById('create-post-avatar');
            if (postAvatar && profileData.avatarUrl) {
                postAvatar.innerHTML = `<img src="${profileData.avatarUrl}" alt="Avatar">`;
            }

            // Club info
            const clubName = window.game?.clubName || 'My Club';
            const clubNameEl = document.getElementById('profile-club-name');
            if (clubNameEl) clubNameEl.textContent = clubName;

            // Level
            const level = window.game?.level || 1;
            const levelBadge = document.getElementById('profile-level-badge');
            if (levelBadge) levelBadge.textContent = `Lv.${level}`;

            // Join date
            const joinDate = user.metadata?.creationTime;
            if (joinDate) {
                const date = new Date(joinDate);
                const joinEl = document.getElementById('profile-join-date');
                if (joinEl) joinEl.textContent = date.toLocaleDateString('en-US', { month: 'short', year: 'numeric' });
            }

            // Last login
            const lastLogin = user.metadata?.lastSignInTime;
            if (lastLogin) {
                const lastActiveEl = document.getElementById('profile-last-active');
                if (lastActiveEl) lastActiveEl.textContent = getRelativeTime(new Date(lastLogin));
            }

            // Stats
            const postsEl = document.getElementById('stat-posts');
            if (postsEl) postsEl.textContent = profileData.posts.length;

            const reactionsEl = document.getElementById('stat-reactions');
            if (reactionsEl) reactionsEl.textContent = profileData.totalReactions;

            const visitorsEl = document.getElementById('stat-visitors');
            if (visitorsEl) visitorsEl.textContent = window.game?.stats?.totalVisitors || 0;

            const earningsEl = document.getElementById('stat-earnings');
            if (earningsEl) earningsEl.textContent = '$' + formatNumber(window.game?.stats?.totalEarnings || 0);

            const hypeEl = document.getElementById('stat-hype');
            if (hypeEl) hypeEl.textContent = Math.round(window.game?.hype || 0);

            const achievementsEl = document.getElementById('stat-achievements');
            if (achievementsEl) achievementsEl.textContent = window.game?.achievements?.length || 0;
        }

        // Format large numbers
        function formatNumber(num) {
            if (num >= 1000000) return (num / 1000000).toFixed(1) + 'M';
            if (num >= 1000) return (num / 1000).toFixed(1) + 'K';
            return num.toString();
        }

        // Get relative time string
        function getRelativeTime(date) {
            const now = new Date();
            const diff = now - date;
            const minutes = Math.floor(diff / 60000);
            const hours = Math.floor(diff / 3600000);
            const days = Math.floor(diff / 86400000);

            if (minutes < 1) return 'Just now';
            if (minutes < 60) return `${minutes}m ago`;
            if (hours < 24) return `${hours}h ago`;
            if (days < 7) return `${days}d ago`;
            return date.toLocaleDateString();
        }

        // Trigger file uploads
        window.triggerCoverUpload = function () {
            const input = document.getElementById('cover-upload-input');
            if (input) {
                input.click();
            } else {
                // Create input dynamically if not found
                const newInput = document.createElement('input');
                newInput.type = 'file';
                newInput.id = 'cover-upload-input';
                newInput.accept = 'image/*';
                newInput.style.display = 'none';
                newInput.onchange = (e) => handleCoverUpload(e);
                document.body.appendChild(newInput);
                newInput.click();
            }
        };

        window.triggerAvatarUpload = function () {
            const input = document.getElementById('avatar-upload-input');
            if (input) {
                input.click();
            } else {
                const newInput = document.createElement('input');
                newInput.type = 'file';
                newInput.id = 'avatar-upload-input';
                newInput.accept = 'image/*';
                newInput.style.display = 'none';
                newInput.onchange = (e) => handleAvatarUpload(e);
                document.body.appendChild(newInput);
                newInput.click();
            }
        };

        window.triggerPostImageUpload = function () {
            const input = document.getElementById('post-image-input');
            if (input) {
                input.click();
            } else {
                const newInput = document.createElement('input');
                newInput.type = 'file';
                newInput.id = 'post-image-input';
                newInput.accept = 'image/*';
                newInput.style.display = 'none';
                newInput.onchange = (e) => handlePostImageSelect(e);
                document.body.appendChild(newInput);
                newInput.click();
            }
        };

        // Handle cover upload
        window.handleCoverUpload = async function (event) {
            const file = event.target.files[0];
            if (!file) return;

            // Validate
            if (!file.type.startsWith('image/')) {
                ui.notify('Please select an image file', 'error');
                return;
            }
            if (file.size > 10 * 1024 * 1024) {
                ui.notify('Image must be less than 10MB', 'error');
                return;
            }

            const user = window.authSystem?.user;
            if (!user) return;

            // Show loading
            const btn = document.querySelector('.profile-cover-edit');
            let originalText = '';
            if (btn) {
                originalText = btn.innerHTML;
                btn.innerHTML = '<i class="ph-fill ph-circle-notch" style="animation:spin 1s linear infinite"></i> Uploading...';
                btn.disabled = true;
            }

            try {
                ui.notify('Compressing & Saving...', 'info');

                // Compress image
                console.log('Starting cover compression...');
                const base64Image = await compressImage(file, 800, 0.6); // Covers can be slightly larger
                console.log('Cover compression successful, length:', base64Image.length);

                profileData.coverUrl = base64Image;
                const coverEl = document.getElementById('profile-cover-photo');
                if (coverEl) coverEl.style.backgroundImage = `url(${base64Image})`;

                // Save to Firebase
                try {
                    console.log('Saving cover to Realtime Database...');
                    await firebase.database().ref(`profiles/${user.uid}/coverUrl`).set(base64Image);
                    console.log('Cover saved to Realtime Database');
                } catch (dbErr) {
                    console.error('DB Save Error (Cover):', dbErr.code, dbErr.message);
                    throw new Error(`DB Error: ${dbErr.code || dbErr.message}`);
                }

                ui.notify('Cover photo updated!', 'success');
            } catch (e) {
                console.error('Cover upload failed:', e);
                const msg = e.message || e.toString() || 'Unknown error';
                ui.notify('Failed to upload cover: ' + msg, 'error');
            } finally {
                if (btn) {
                    btn.innerHTML = originalText;
                    btn.disabled = false;
                }
                event.target.value = '';
            }
        };

        // Helper to compress image
        const compressImage = (file, maxWidth = 800, quality = 0.7) => {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = (event) => {
                    const img = new Image();
                    img.src = event.target.result;
                    img.onload = () => {
                        try {
                            const elem = document.createElement('canvas');
                            let width = img.width;
                            let height = img.height;

                            if (width > maxWidth) {
                                height = Math.round(height * (maxWidth / width));
                                width = maxWidth;
                            }

                            elem.width = width;
                            elem.height = height;
                            const ctx = elem.getContext('2d');
                            ctx.drawImage(img, 0, 0, width, height);

                            // Convert to base64
                            const dataUrl = elem.toDataURL('image/jpeg', quality);
                            resolve(dataUrl);
                        } catch (e) {
                            reject(new Error('Compression failed: ' + e.message));
                        }
                    };
                    img.onerror = () => reject(new Error('Failed to load image for compression'));
                };
                reader.onerror = () => reject(new Error('Failed to read file'));
            });
        };

        // Handle avatar upload
        window.handleAvatarUpload = async function (event) {
            console.log('handleAvatarUpload called'); // Debug log
            const file = event.target.files[0];
            if (!file) {
                console.log('No file selected');
                return;
            }

            if (!file.type.startsWith('image/')) {
                ui.notify('Please select an image file', 'error');
                return;
            }

            // Force check user from multiple sources
            const user = firebase.auth().currentUser || window.authSystem?.user;
            console.log('User for upload:', user ? user.uid : 'null');

            if (!user) {
                ui.notify('You must be logged in', 'error');
                return;
            }

            try {
                ui.notify('Compressing & Saving...', 'info');

                // Compress to avoid large payloads in DB
                console.log('Starting compression...');
                // Reduce size further to 300px/0.6 to ensure we stay well within limits
                const base64Image = await compressImage(file, 300, 0.6);
                console.log('Compression successful, length:', base64Image.length);

                profileData.avatarUrl = base64Image;

                // Update UI
                const avatarImg = document.getElementById('profile-avatar-img');
                if (avatarImg) {
                    avatarImg.src = base64Image;
                    avatarImg.style.display = 'block';
                }
                const avatarFallback = document.querySelector('.profile-avatar-fallback');
                if (avatarFallback) avatarFallback.style.display = 'none';

                // Update post avatar
                const postAvatar = document.getElementById('create-post-avatar');
                if (postAvatar) postAvatar.innerHTML = `<img src="${base64Image}" alt="Avatar">`;

                // Save directly to Firebase Database
                try {
                    console.log('Saving to Realtime Database...');
                    await firebase.database().ref(`profiles/${user.uid}/avatarUrl`).set(base64Image);
                    console.log('Saved to Realtime Database');
                } catch (dbErr) {
                    console.error('DB Save Error details:', dbErr.code, dbErr.message);
                    throw new Error(`DB Error: ${dbErr.code || dbErr.message}`);
                }

                try {
                    console.log('Updating Auth Profile...');
                    await user.updateProfile({ photoURL: base64Image });
                    console.log('Auth Profile updated');
                } catch (authErr) {
                    // Silently ignore invalid-profile-attribute error (Base64 too long for Auth)
                    // Image is successfully saved to Realtime Database and will load from there
                    if (authErr.code !== 'auth/invalid-profile-attribute') {
                        console.error('Auth Update Error:', authErr);
                    }
                }

                ui.notify('Profile picture updated!', 'success');
            } catch (e) {
                console.error('Avatar save failed object:', e);
                const msg = e.message || e.toString() || 'Unknown error';
                console.error('Avatar save failed message:', msg);
                ui.notify('Failed to save: ' + msg, 'error');
            }
            event.target.value = '';
        };

        // Handle post image selection
        window.handlePostImageSelect = function (event) {
            const file = event.target.files[0];
            if (!file) return;

            if (!file.type.startsWith('image/')) {
                ui.notify('Please select an image file', 'error');
                return;
            }
            if (file.size > 8 * 1024 * 1024) {
                ui.notify('Image must be less than 8MB', 'error');
                return;
            }

            selectedPostImage = file;

            // Show preview
            const reader = new FileReader();
            reader.onload = (e) => {
                const previewImg = document.getElementById('post-preview-img');
                const previewContainer = document.getElementById('post-image-preview');
                if (previewImg) previewImg.src = e.target.result;
                if (previewContainer) previewContainer.classList.add('has-image');
            };
            reader.readAsDataURL(file);
        };

        // Remove selected post image
        window.removePostImage = function () {
            selectedPostImage = null;
            const previewContainer = document.getElementById('post-image-preview');
            if (previewContainer) previewContainer.classList.remove('has-image');
            const input = document.getElementById('post-image-input');
            if (input) input.value = '';
        };

        // Add emoji to post
        window.addEmoji = function () {
            const emojis = ['üòä', 'üéâ', 'üî•', 'üíØ', 'üéµ', 'üé∂', 'üíÉ', 'üï∫', 'üçæ', 'ü•≥', '‚ú®', 'üåü'];
            const textarea = document.getElementById('post-text-input');
            if (!textarea) return;
            const randomEmoji = emojis[Math.floor(Math.random() * emojis.length)];
            textarea.value += randomEmoji;
            textarea.focus();
        };

        // Submit post
        window.submitPost = async function () {
            const textarea = document.getElementById('post-text-input');
            if (!textarea) return;
            const text = textarea.value.trim();

            if (!text && !selectedPostImage) {
                ui.notify('Write something or add a photo', 'error');
                return;
            }

            const user = window.authSystem?.user;
            if (!user) return;

            const submitBtn = document.getElementById('post-submit-btn');
            if (!submitBtn) return;
            const originalText = submitBtn.innerHTML;
            submitBtn.innerHTML = '<i class="ph-fill ph-circle-notch" style="animation:spin 1s linear infinite"></i>';
            submitBtn.disabled = true;

            try {
                let imageUrl = null;

                // Upload image if selected
                if (selectedPostImage) {
                    // Compress image
                    imageUrl = await compressImage(selectedPostImage, 600, 0.7);
                }

                // Create post object
                const post = {
                    id: Date.now().toString(),
                    text: text,
                    imageUrl: imageUrl,
                    timestamp: Date.now(),
                    authorName: user.displayName || user.email?.split('@')[0] || 'Player',
                    authorAvatar: profileData.avatarUrl,
                    reactions: {}
                };

                // Save to Firebase
                await firebase.database().ref(`profiles/${user.uid}/posts/${post.id}`).set(post);

                // Update local data
                profileData.posts.unshift(post);

                // Update UI
                const postsCountEl = document.getElementById('stat-posts');
                if (postsCountEl) postsCountEl.textContent = profileData.posts.length;
                textarea.value = '';
                removePostImage();
                loadPosts();

                ui.notify('Post shared!', 'success');
            } catch (e) {
                console.error('Failed to create post:', e);
                ui.notify('Failed to share post: ' + e.message, 'error');
            } finally {
                submitBtn.innerHTML = originalText;
                submitBtn.disabled = false;
            }
        };

        // Load and render posts
        function loadPosts() {
            const container = document.getElementById('posts-feed-container');
            if (!container) return;

            if (profileData.posts.length === 0) {
                container.innerHTML = `
                    <div class="no-posts-message">
                        <i class="ph-light ph-note-blank"></i>
                        <p>No posts yet</p>
                        <span>Share your first club update!</span>
                    </div>
                `;
                return;
            }

            // Sort by timestamp descending
            const sortedPosts = [...profileData.posts].sort((a, b) => b.timestamp - a.timestamp);

            container.innerHTML = sortedPosts.map(post => renderPost(post)).join('');
        }

        // Render single post
        function renderPost(post) {
            const reactionCount = post.reactions ? Object.keys(post.reactions).length : 0;
            const topReactions = getTopReactions(post.reactions);
            const userReaction = getUserReaction(post);

            return `
                <div class="post-item" data-post-id="${post.id}">
                    <div class="post-author-row">
                        <div class="post-author-avatar">
                            ${post.authorAvatar ? `<img src="${post.authorAvatar}" alt="">` : 'üë§'}
                        </div>
                        <div class="post-author-info">
                            <div class="post-author-name">${post.authorName}</div>
                            <div class="post-time">${getRelativeTime(new Date(post.timestamp))}</div>
                        </div>
                    </div>
                    ${post.text ? `<div class="post-text">${escapeHtml(post.text)}</div>` : ''}
                    ${post.imageUrl ? `<img src="${post.imageUrl}" class="post-image" onclick="viewImage('${post.imageUrl}')">` : ''}
                    <div class="post-reactions-row">
                        <div class="reactions-summary">
                            ${topReactions.length > 0 ? `
                                <div class="reaction-icons-display">${topReactions.map(r => `<span>${REACTIONS[r].emoji}</span>`).join('')}</div>
                                <span>${reactionCount}</span>
                            ` : '<span>Be the first to react</span>'}
                        </div>
                        <div class="reaction-btns">
                            ${Object.entries(REACTIONS).map(([key, value]) => `
                                <button class="react-btn ${userReaction === key ? 'active' : ''}" 
                                        onclick="reactToPost('${post.id}', '${key}')" 
                                        title="${value.label}">
                                    ${value.emoji}
                                </button>
                            `).join('')}
                        </div>
                    </div>
                </div>
            `;
        }

        // Get top reactions for a post
        function getTopReactions(reactions) {
            if (!reactions) return [];
            const counts = {};
            Object.values(reactions).forEach(r => {
                counts[r] = (counts[r] || 0) + 1;
            });
            return Object.entries(counts)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 3)
                .map(([type]) => type);
        }

        // Get user's reaction to a post
        function getUserReaction(post) {
            const user = window.authSystem?.user;
            if (!user || !post.reactions) return null;
            return post.reactions[user.uid] || null;
        }

        // React to a post
        window.reactToPost = async function (postId, reactionType) {
            const user = window.authSystem?.user;
            if (!user) return;

            try {
                const reactionRef = firebase.database().ref(`profiles/${user.uid}/posts/${postId}/reactions/${user.uid}`);
                const snapshot = await reactionRef.once('value');
                const currentReaction = snapshot.val();

                if (currentReaction === reactionType) {
                    // Remove reaction
                    await reactionRef.remove();
                    profileData.totalReactions = Math.max(0, profileData.totalReactions - 1);
                } else {
                    // Add/change reaction
                    await reactionRef.set(reactionType);
                    if (!currentReaction) {
                        profileData.totalReactions++;
                    }
                }

                // Update total reactions in Firebase
                await firebase.database().ref(`profiles/${user.uid}/totalReactions`).set(profileData.totalReactions);

                // Update local posts
                const post = profileData.posts.find(p => p.id === postId);
                if (post) {
                    if (!post.reactions) post.reactions = {};
                    if (currentReaction === reactionType) {
                        delete post.reactions[user.uid];
                    } else {
                        post.reactions[user.uid] = reactionType;
                    }
                }

                // Re-render posts
                loadPosts();
                const reactionsEl = document.getElementById('stat-reactions');
                if (reactionsEl) reactionsEl.textContent = profileData.totalReactions;
            } catch (e) {
                console.error('Failed to react:', e);
            }
        };

        // Escape HTML to prevent XSS
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // View image in full screen
        window.viewImage = function (url) {
            const overlay = document.createElement('div');
            overlay.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,0.9);z-index:9999;display:flex;align-items:center;justify-content:center;cursor:zoom-out;';
            overlay.innerHTML = `<img src="${url}" style="max-width:90%;max-height:90%;object-fit:contain;border-radius:8px;">`;
            overlay.onclick = () => overlay.remove();
            document.body.appendChild(overlay);
        };

        // Open edit profile modal
        window.openEditProfile = function () {
            const newBio = prompt('Update your bio:', profileData.bio);
            if (newBio !== null && newBio !== profileData.bio) {
                profileData.bio = newBio;
                const bioEl = document.getElementById('profile-bio');
                if (bioEl) bioEl.textContent = newBio;

                const user = window.authSystem?.user;
                if (user) {
                    firebase.database().ref(`profiles/${user.uid}/bio`).set(newBio);
                }
                ui.notify('Bio updated!', 'success');
            }
        };

        // Hook into modal open to initialize profile
        const originalOpenModal = window.game?.openModal;
        if (originalOpenModal) {
            window.game.openModal = function (modalName) {
                originalOpenModal.call(window.game, modalName);
                if (modalName === 'profile') {
                    setTimeout(() => initFBProfile(), 100);
                }
            };
        }

        // Also initialize when profile modal becomes visible
        const profileModal = document.getElementById('profile-modal');
        if (profileModal) {
            const observer = new MutationObserver((mutations) => {
                mutations.forEach((mutation) => {
                    if (mutation.type === 'attributes' && mutation.attributeName === 'class') {
                        if (!profileModal.classList.contains('hidden')) {
                            initFBProfile();
                        }
                    }
                });
            });
            observer.observe(profileModal, { attributes: true });
        }

        // Initialize when THREE.js is loaded
        if (typeof THREE !== 'undefined') {
            initHero3D();
        } else {
            // Wait for THREE to load
            const checkThree = setInterval(() => {
                if (typeof THREE !== 'undefined') {
                    clearInterval(checkThree);
                    initHero3D();
                }
            }, 100);
        }

        // ================== VISIT CLUB FEATURE ==================
        let currentVisitData = null;
        let visitClubListener = null;

        window.openVisitClubModal = async function (friendUid) {
            const modal = document.getElementById('visit-club-modal');
            if (!modal) return;

            // Show modal with loading state
            modal.classList.remove('hidden');

            try {
                // Get friend info
                const friend = friendsSystem?.friends?.find(f => f.uid === friendUid);
                if (!friend) {
                    if (window.ui) window.ui.notify('Friend not found', 'error');
                    closeVisitClubModal();
                    return;
                }

                const db = firebase.database();

                // Set currentVisitData immediately with friend info
                currentVisitData = {
                    friendUid,
                    friend,
                    club: {}
                };

                // Fetch club data with once() for immediate access
                const clubSnapshot = await db.ref(`clubs/${friendUid}`).once('value');
                const clubData = clubSnapshot.val() || {};

                // Update currentVisitData with club data
                currentVisitData = {
                    friendUid,
                    friend,
                    club: clubData
                };

                // Update UI
                updateVisitClubUI(friend, clubData);

            } catch (e) {
                console.error('Failed to open visit club modal:', e);
                if (window.ui) window.ui.notify('Failed to load club data', 'error');
            }
        };

        // Helper function for notifications
        function notify(msg, type) {
            if (window.ui && window.ui.notify) {
                window.ui.notify(msg, type);
            } else {
                console.log(`[${type}] ${msg}`);
            }
        }

        // Enter fullscreen 3D view of friend's club
        window.enterFullscreenVisit = async function () {
            console.log('enterFullscreenVisit called');
            console.log('currentVisitData:', currentVisitData);

            if (!currentVisitData || !currentVisitData.friend) {
                notify('Please wait for club data to load', 'info');
                return;
            }

            // Extract data BEFORE closing modal (which clears currentVisitData)
            const { friendUid, friend, club } = currentVisitData;
            const clubName = club?.name || `${friend.name}'s Club`;

            console.log('Friend UID:', friendUid);
            console.log('Friend:', friend);

            // Store visit data
            window.visitModeData = {
                friendUid,
                friendName: friend.name,
                friendLevel: friend.level || 1,
                clubName: clubName,
                active: true
            };

            // NOW close the visit modal
            closeVisitClubModal();

            // Show loading screen
            showVisitLoadingScreen(friend.name);

            // Close all modals first
            document.querySelectorAll('.modal-overlay').forEach(m => m.classList.add('hidden'));

            // Load friend's club data into the current game
            try {
                // Check if game exists
                if (!window.game) {
                    notify('Game not loaded yet. Please wait.', 'error');
                    return;
                }

                // Use Firestore (not Realtime Database) - saves are stored there
                const db = firebase.firestore();
                console.log('Fetching friend data from Firestore: saves/' + friendUid);
                const doc = await db.collection('saves').doc(friendUid).get();
                const friendData = doc.exists ? doc.data() : null;

                console.log('Friend data:', friendData);
                console.log('Friend furniture:', friendData?.furniture);

                // Check if friend has saved data
                if (!friendData) {
                    notify(`${friend.name} hasn't set up their club yet!`, 'info');
                    // Still show banner with empty club
                    showVisitModeBanner(friend.name);
                    hideEditControlsForVisit();
                    window.game.visitMode = true;
                    return;
                }

                // Show visit mode banner
                showVisitModeBanner(friend.name);

                // Disable editing in visit mode FIRST
                window.game.visitMode = true;

                // CRITICAL: Block auto-save during visit mode to prevent overwriting user's data
                if (window.cloudSave) {
                    window.cloudSave.blockSaves = true;
                }

                // Load friend's data into game (this sets savedFurniture and clubTier)
                console.log('Loading friend data into game...');
                window.game.loadFromSave(friendData);

                // Override club display info
                window.game.clubName = window.visitModeData.clubName;
                window.game.ownerName = friend.name;

                console.log('Friend clubTier:', window.game.clubTier);
                console.log('Saved furniture after load:', window.game.savedFurniture);

                // Hide edit controls
                hideEditControlsForVisit();

                // Rebuild club structure (walls, floor) with friend's club tier
                if (window.rebuildClubStructure) {
                    console.log('Calling rebuildClubStructure for tier:', window.game.clubTier);
                    window.rebuildClubStructure();
                } else {
                    console.warn('rebuildClubStructure not available!');
                }

                // Rebuild the scene with friend's furniture
                if (window.rebuildSceneFurniture) {
                    console.log('Calling rebuildSceneFurniture...');
                    window.rebuildSceneFurniture();
                } else {
                    console.warn('rebuildSceneFurniture not available!');
                }

                window.game.updateUI();
                notify(`Now viewing ${friend.name}'s club!`, 'success');

            } catch (e) {
                console.error('Failed to load friend club:', e);
                hideVisitLoadingScreen();
                notify('Failed to load club: ' + e.message, 'error');
            }
        };

        function showVisitLoadingScreen(friendName) {
            const loading = document.createElement('div');
            loading.id = 'visit-loading-screen';
            loading.innerHTML = `
                <div class="visit-loading-content">
                    <div class="visit-loading-spinner"></div>
                    <h2>Visiting ${friendName}'s Club</h2>
                    <p>Loading club data...</p>
                </div>
            `;
            loading.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.9);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 99999;
                color: white;
                font-family: 'Outfit', sans-serif;
            `;

            // Add spinner animation
            const style = document.createElement('style');
            style.id = 'visit-loading-style';
            style.textContent = `
                .visit-loading-content {
                    text-align: center;
                }
                .visit-loading-content h2 {
                    font-size: 24px;
                    margin: 20px 0 10px;
                    color: #a855f7;
                }
                .visit-loading-content p {
                    color: #888;
                    font-size: 14px;
                }
                .visit-loading-spinner {
                    width: 50px;
                    height: 50px;
                    border: 4px solid rgba(168, 85, 247, 0.3);
                    border-top-color: #a855f7;
                    border-radius: 50%;
                    animation: spin 1s linear infinite;
                    margin: 0 auto;
                }
                @keyframes spin {
                    to { transform: rotate(360deg); }
                }
            `;
            document.head.appendChild(style);
            document.body.appendChild(loading);
        }

        function hideVisitLoadingScreen() {
            const loading = document.getElementById('visit-loading-screen');
            if (loading) loading.remove();
            const style = document.getElementById('visit-loading-style');
            if (style) style.remove();
        }

        function showVisitModeBanner(friendName) {
            // Remove loading screen
            hideVisitLoadingScreen();

            // Remove existing banner if any
            const existingBanner = document.getElementById('visit-mode-banner');
            if (existingBanner) existingBanner.remove();

            const banner = document.createElement('div');
            banner.id = 'visit-mode-banner';
            banner.innerHTML = `
                <div class="visit-banner-left">
                    <span class="visit-icon">üëÄ</span>
                    <span class="visit-text">Visiting <strong>${friendName}'s Club</strong></span>
                    <span class="visit-tag">PREVIEW</span>
                </div>
                <div class="visit-banner-right">
                    <button class="visit-gift-btn" onclick="sendGiftFromVisit()">
                        <i class="ph-fill ph-gift"></i> Send Gift
                    </button>
                    <button class="visit-back-btn" onclick="exitVisitMode()">
                        <i class="ph-fill ph-house"></i> Go Back to My Club
                    </button>
                </div>
            `;
            document.body.appendChild(banner);
            document.body.classList.add('visit-mode-active');
        }

        function hideAllUIForVisit() {
            // Hide the entire #ui-layer
            const uiLayer = document.getElementById('ui-layer');
            if (uiLayer) {
                uiLayer.setAttribute('data-visit-hidden', 'true');
                uiLayer.style.setProperty('display', 'none', 'important');
            }

            // Hide all fixed position elements (sidebars, bottom bar)
            document.querySelectorAll('.fixed').forEach(el => {
                if (el.id !== 'visit-mode-banner' && !el.closest('#visit-mode-banner') && el.id !== 'canvas-container') {
                    el.setAttribute('data-visit-hidden', 'true');
                    el.style.setProperty('display', 'none', 'important');
                }
            });

            // Hide all glass-panel elements
            document.querySelectorAll('.glass-panel').forEach(el => {
                if (!el.closest('#visit-mode-banner') && !el.closest('.modal-overlay')) {
                    el.setAttribute('data-visit-hidden', 'true');
                    el.style.setProperty('display', 'none', 'important');
                }
            });

            // Hide specific elements by ID
            const idsToHide = [
                'now-playing-widget', 'profile-btn', 'btn-event', 'vip-badge', 'notification-bell',
                'furniture-edit-bar', 'edit-controls', 'chat-dock-btn', 'restock-btn', 'btn-mode',
                'stock-box', 'friends-dock-btn', 'world-dock-btn', 'notification-panel'
            ];
            idsToHide.forEach(id => {
                const el = document.getElementById(id);
                if (el) {
                    el.setAttribute('data-visit-hidden', 'true');
                    el.style.setProperty('display', 'none', 'important');
                }
            });
        }

        function showAllUIAfterVisit() {
            // Restore all hidden UI elements
            document.querySelectorAll('[data-visit-hidden="true"]').forEach(el => {
                el.removeAttribute('data-visit-hidden');
                el.style.display = '';
            });
        }

        function hideEditControlsForVisit() {
            // Hide ALL UI - just show the 3D scene and banner
            hideAllUIForVisit();
        }

        window.sendGiftFromVisit = function () {
            if (!window.visitModeData) return;
            const { friendUid, friendName } = window.visitModeData;
            if (friendsSystem && typeof friendsSystem.openGiftModal === 'function') {
                friendsSystem.openGiftModal(friendUid, friendName);
            }
        };

        window.exitVisitMode = async function () {
            // Show loading screen
            const loading = document.createElement('div');
            loading.id = 'visit-loading-screen';
            loading.innerHTML = `
                <div class="visit-loading-content">
                    <div class="visit-loading-spinner"></div>
                    <h2>Returning to Your Club</h2>
                    <p>Loading your data...</p>
                </div>
            `;
            loading.style.cssText = `
                position: fixed; top: 0; left: 0; width: 100%; height: 100%;
                background: rgba(0, 0, 0, 0.9); display: flex;
                align-items: center; justify-content: center; z-index: 99999;
                color: white; font-family: 'Outfit', sans-serif;
            `;
            document.body.appendChild(loading);

            // Remove banner
            const banner = document.getElementById('visit-mode-banner');
            if (banner) banner.remove();
            document.body.classList.remove('visit-mode-active');

            // Clear visit mode
            window.visitModeData = null;
            if (window.game) {
                window.game.visitMode = false;
            }

            // Reload user's own club
            if (window.cloudSave) {
                // Re-enable saves AFTER loading user's own data
                window.cloudSave.blockSaves = false;
                const userData = await window.cloudSave.loadGame();
                if (userData && window.game) {
                    window.game.loadFromSave(userData);

                    // Rebuild club structure with user's own club tier
                    if (window.rebuildClubStructure) {
                        console.log('Rebuilding club structure for user tier:', window.game.clubTier);
                        window.rebuildClubStructure();
                    }

                    if (window.rebuildSceneFurniture) {
                        window.rebuildSceneFurniture();
                    }
                    window.game.updateUI();
                }
            }

            // Restore ALL UI elements
            showAllUIAfterVisit();

            // Remove loading screen
            hideVisitLoadingScreen();

            notify('Welcome back to your club!', 'success');
        };

        // Recovery function - call from console: window.fixMyProfile("YourName", "YourClubName")
        window.fixMyProfile = async function (name, clubName) {
            if (!window.game || !window.authSystem?.user) {
                console.error('Game or auth not ready');
                return;
            }

            // Update local game
            window.game.ownerName = name;
            window.game.clubName = clubName || name;

            // Update auth profile
            if (window.authSystem.updateUserData) {
                await window.authSystem.updateUserData({
                    displayName: name,
                    clubName: clubName || name
                });
            }

            // Force save to cloud
            if (window.cloudSave) {
                window.cloudSave.blockSaves = false;
                await window.cloudSave.saveGame(window.game.getSaveData(), true);
            }

            // Update UI
            window.game.updateUI();
            if (window.updateClubDisplay) window.updateClubDisplay();
            if (window.updateProfileModal) window.updateProfileModal();

            console.log('Profile fixed! Name:', name, 'Club:', clubName);
            notify('Profile restored!', 'success');
        };

        function updateVisitClubUI(friend, clubData) {
            // Update header
            document.getElementById('visit-club-name').textContent = clubData.name || `${friend.name}'s Club`;
            document.getElementById('visit-club-owner').textContent = `by ${friend.name}`;
            document.getElementById('visit-club-level').innerHTML = `<i class="ph-fill ph-star"></i> Level ${friend.level || clubData.level || 1}`;

            // Update avatar
            const avatarEl = document.getElementById('visit-club-avatar');
            if (friend.avatarUrl) {
                avatarEl.innerHTML = `<img src="${friend.avatarUrl}" alt="">`;
            } else {
                avatarEl.innerHTML = 'üè¢';
            }

            // Update banner
            const bannerEl = document.getElementById('visit-club-banner');
            if (clubData.bannerUrl) {
                bannerEl.style.backgroundImage = `url(${clubData.bannerUrl})`;
            }

            // Update stats
            const guests = clubData.currentGuests || Math.floor(Math.random() * 20) + 5;
            const hype = clubData.hype || Math.floor(Math.random() * 100) + 10;
            const furniture = clubData.furnitureCount || Math.floor(Math.random() * 15) + 3;
            const earnings = clubData.totalEarnings || Math.floor(Math.random() * 10000) + 500;

            document.getElementById('visit-guests').textContent = guests;
            document.getElementById('visit-hype').textContent = Math.round(hype);
            document.getElementById('visit-furniture').textContent = furniture;
            document.getElementById('visit-earnings').textContent = '$' + formatVisitNumber(earnings);

            // Update preview area
            updateClubPreview(clubData, guests);

            // Update activity feed
            updateActivityFeed(clubData, friend.name);
        }

        function updateClubPreview(clubData, guestCount) {
            const previewArea = document.getElementById('visit-preview-area');

            // Sample furniture icons
            const furnitureIcons = ['ü™ë', 'üõãÔ∏è', 'üéß', 'üí°', 'üé§', 'üç∏', 'üé∞', 'üéµ', 'üíé', 'üåü'];
            const furnitureCount = clubData.furnitureCount || Math.floor(Math.random() * 8) + 3;

            let furnitureHTML = '';
            for (let i = 0; i < Math.min(furnitureCount, 8); i++) {
                const icon = furnitureIcons[i % furnitureIcons.length];
                furnitureHTML += `<div class="preview-furniture-item">${icon}</div>`;
            }

            // Guest avatars
            const guestEmojis = ['üßë', 'üë©', 'üë®', 'üßî', 'üë±', 'üë©‚Äçü¶∞', 'üë®‚Äçü¶±', 'üë©‚Äçü¶≥'];
            let guestsHTML = '';
            for (let i = 0; i < Math.min(guestCount, 10); i++) {
                const emoji = guestEmojis[i % guestEmojis.length];
                guestsHTML += `<div class="preview-guest">${emoji}</div>`;
            }

            previewArea.innerHTML = `
                <div class="visit-preview-content">
                    ${furnitureHTML}
                </div>
                <div class="preview-guests">
                    ${guestsHTML}
                </div>
            `;
        }

        function updateActivityFeed(clubData, ownerName) {
            const feedEl = document.getElementById('visit-activity-feed');

            // Generate random activities
            const activities = [
                { type: 'guest', icon: 'ph-user-plus', text: 'A new guest arrived!' },
                { type: 'cash', icon: 'ph-currency-dollar', text: `${ownerName} earned $${Math.floor(Math.random() * 50) + 10}` },
                { type: 'hype', icon: 'ph-fire', text: 'Hype is rising! üî•' },
                { type: 'guest', icon: 'ph-music-notes', text: 'Guests are dancing! üíÉ' },
                { type: 'cash', icon: 'ph-champagne', text: 'VIP ordered drinks!' },
            ];

            // Shuffle and take 3
            const shuffled = activities.sort(() => 0.5 - Math.random()).slice(0, 3);

            feedEl.innerHTML = shuffled.map((activity, i) => `
                <div class="activity-item ${activity.type}">
                    <i class="ph-fill ${activity.icon}"></i>
                    <span>${activity.text}</span>
                    <span class="activity-time">${i + 1}m ago</span>
                </div>
            `).join('');
        }

        function formatVisitNumber(num) {
            if (num >= 1000000) return (num / 1000000).toFixed(1) + 'M';
            if (num >= 1000) return (num / 1000).toFixed(1) + 'K';
            return num.toString();
        }

        window.closeVisitClubModal = function () {
            const modal = document.getElementById('visit-club-modal');
            if (modal) modal.classList.add('hidden');

            // Clear listener
            if (visitClubListener) {
                const friendUid = currentVisitData?.friendUid;
                if (friendUid) {
                    firebase.database().ref(`clubs/${friendUid}`).off('value', visitClubListener);
                }
                visitClubListener = null;
            }
            currentVisitData = null;
        };

        window.claimVisitReward = async function () {
            if (!currentVisitData) return;

            const { friendUid, friend } = currentVisitData;
            const user = window.authSystem?.user;
            if (!user) {
                ui.notify('Please login first', 'error');
                return;
            }

            const claimBtn = document.getElementById('visit-claim-btn');
            if (claimBtn.disabled) return;

            try {
                claimBtn.disabled = true;
                claimBtn.innerHTML = '<i class="ph-fill ph-circle-notch" style="animation:spin 1s linear infinite"></i><span>Claiming...</span>';

                const level = friend.level || 1;
                const cashReward = 50 + level * 10;
                const xpReward = 10 + level * 5;
                const hypeReward = Math.floor(level / 2) + 1;

                // Mark as visited
                const today = new Date().toDateString().replace(/\s/g, '_');
                await firebase.database().ref(`visits/${user.uid}/${today}/${friendUid}`).set({
                    timestamp: firebase.database.ServerValue.TIMESTAMP
                });

                // Give rewards
                if (window.game) {
                    window.game.cash += cashReward;
                    window.game.xp += xpReward;
                    window.game.hype += hypeReward;
                    window.game.updateUI();
                }

                // Update button
                claimBtn.innerHTML = '<i class="ph-fill ph-check"></i><span>Reward Claimed!</span>';

                ui.notify(`Earned $${cashReward}, ${xpReward} XP, +${hypeReward} Hype!`, 'success');

                // Play sound
                if (window.audioManager) {
                    audioManager.play('cash');
                }

            } catch (e) {
                console.error('Failed to claim reward:', e);
                ui.notify('Failed to claim reward', 'error');
                claimBtn.disabled = false;
                claimBtn.innerHTML = '<i class="ph-fill ph-gift"></i><span>Claim Visit Reward</span>';
            }
        };

        window.sendGiftToFriend = function () {
            if (!currentVisitData) return;

            const { friendUid, friend } = currentVisitData;

            // Open gift modal if friendsSystem has it
            if (friendsSystem && typeof friendsSystem.openGiftModal === 'function') {
                friendsSystem.openGiftModal(friendUid, friend.name);
            } else {
                ui.notify('Gift system not available', 'info');
            }
        };

        // ================== CONSOLE ERROR REPORTER ==================
        (function () {
            // Create error container
            const errorContainer = document.createElement('div');
            errorContainer.id = 'error-reporter';
            errorContainer.style.cssText = `
                position: fixed;
                bottom: 20px;
                right: 20px;
                max-width: 400px;
                max-height: 300px;
                overflow-y: auto;
                z-index: 99999;
                font-family: 'Consolas', 'Monaco', monospace;
                font-size: 12px;
                pointer-events: auto;
            `;
            document.body.appendChild(errorContainer);

            // Error display function
            function showError(type, message, source, line) {
                const errorEl = document.createElement('div');
                errorEl.style.cssText = `
                    background: ${type === 'error' ? 'rgba(180, 30, 30, 0.95)' : 'rgba(180, 120, 30, 0.95)'};
                    color: white;
                    padding: 10px 14px;
                    margin-bottom: 8px;
                    border-radius: 8px;
                    box-shadow: 0 4px 15px rgba(0,0,0,0.4);
                    border-left: 4px solid ${type === 'error' ? '#ff4444' : '#ffaa00'};
                    animation: slideIn 0.3s ease;
                `;

                const sourceInfo = source ? ` at ${source.split('/').pop()}:${line}` : '';
                errorEl.innerHTML = `
                    <div style="display:flex; justify-content:space-between; align-items:start;">
                        <span style="font-weight:bold; text-transform:uppercase; font-size:10px; opacity:0.8;">
                            ${type === 'error' ? '‚ùå Error' : '‚ö†Ô∏è Warning'}
                        </span>
                        <button onclick="this.parentElement.parentElement.remove()" 
                                style="background:none; border:none; color:white; cursor:pointer; font-size:14px; opacity:0.7;">√ó</button>
                    </div>
                    <div style="margin-top:6px; word-break:break-word;">${message}${sourceInfo}</div>
                `;

                errorContainer.appendChild(errorEl);

                // Auto-remove after 10 seconds
                setTimeout(() => {
                    if (errorEl.parentElement) {
                        errorEl.style.opacity = '0';
                        errorEl.style.transform = 'translateX(100%)';
                        errorEl.style.transition = 'all 0.3s ease';
                        setTimeout(() => errorEl.remove(), 300);
                    }
                }, 10000);
            }

            // Capture errors
            window.onerror = function (message, source, line, col, error) {
                showError('error', message, source, line);
                return false;
            };

            // Capture promise rejections
            window.addEventListener('unhandledrejection', function (event) {
                showError('error', 'Unhandled Promise: ' + (event.reason?.message || event.reason || 'Unknown'));
            });

            // Safe stringify that handles circular references
            const safeStringify = (obj) => {
                try {
                    if (typeof obj === 'object' && obj !== null) {
                        // Try to stringify, but catch circular reference errors
                        const seen = new WeakSet();
                        return JSON.stringify(obj, (key, value) => {
                            if (typeof value === 'object' && value !== null) {
                                if (seen.has(value)) return '[Circular]';
                                seen.add(value);
                            }
                            return value;
                        });
                    }
                    return String(obj);
                } catch (e) {
                    return String(obj);
                }
            };

            // Capture console.error
            const originalError = console.error;
            console.error = function (...args) {
                showError('error', args.map(a => typeof a === 'object' ? safeStringify(a) : String(a)).join(' '));
                originalError.apply(console, args);
            };

            // Capture console.warn (but filter out Firebase index warnings)
            const originalWarn = console.warn;
            console.warn = function (...args) {
                const msg = args.map(a => typeof a === 'object' ? safeStringify(a) : String(a)).join(' ');
                // Filter out Firebase index warnings - they're just performance suggestions
                if (!msg.includes('FIREBASE WARNING') && !msg.includes('@firebase')) {
                    showError('warn', msg);
                }
                originalWarn.apply(console, args);
            };

            // Add animation
            const style = document.createElement('style');
            style.textContent = `
                @keyframes slideIn {
                    from { opacity: 0; transform: translateX(100%); }
                    to { opacity: 1; transform: translateX(0); }
                }
            `;
            document.head.appendChild(style);

            console.log('üìü Error reporter initialized');
        })();
    </script>
    <!-- Offline Checker -->
    <script src="js/offline-checker.js"></script>
</body>

</html>